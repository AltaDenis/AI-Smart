<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI-Smart — Платформа для менеджеров Яндекс Маркета</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" />
  <style>
    :root {
      --bg-primary: #11131a;
      --bg-secondary: #1e2128;
      --bg-tertiary: #2a2e37;
      --bg-quaternary: #3a3f4b;
      --text-primary: #e6e6e6;
      --text-secondary: #a0a0a0;
      --text-tertiary: #777;
      --accent-blue: #2a7fff;
      --accent-hover: #3b8cff;
      --accent-active: #1c6ed1;
      --success: #22c55e;
      --error: #ef4444;
      --border: #3a3f4b;
      --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      --glow: 0 0 15px rgba(42, 127, 255, 0.4);
      --radius-md: 8px;
      --radius-lg: 12px;
      --transition: 0.3s ease;
      --sidebar-width: 260px;
    }

    [data-theme="light"] {
      --bg-primary: #f7f8fa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f3f5;
      --bg-quaternary: #e9ecef;
      --text-primary: #11131a;
      --text-secondary: #4a4a4a;
      --text-tertiary: #6b7280;
      --border: #d1d5db;
      --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      display: flex; min-height: 100vh; overflow: hidden;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border-right: 1px solid var(--border);
      padding: 20px 0; display: flex; flex-direction: column; height: 100vh;
      position: fixed; left: 0; top: 0; transition: var(--transition); z-index: 100;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .logo { padding: 0 20px 20px; font-size: 20px; font-weight: 700; color: white; display: flex; align-items: center; gap: 12px; }
    .logo span { color: var(--accent-blue); }

    .nav-menu { flex: 1; padding: 10px 0; }
    .nav-section { margin-bottom: 30px; }
    .nav-section-title { color: var(--text-tertiary); font-size: 12px; font-weight: 600; text-transform: uppercase; padding: 0 20px 10px; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
    .nav-section-title i { color: var(--accent-blue); font-size: 14px; }

    .nav-item { display: flex; align-items: center; padding: 12px 20px; color: var(--text-secondary); cursor: pointer; transition: var(--transition); gap: 16px; font-weight: 500; border-radius: 8px; margin: 0 10px; }
    .nav-item:hover { background: rgba(42, 127, 255, 0.1); color: var(--text-primary); }
    .nav-item.active { background: rgba(42, 127, 255, 0.15); color: var(--accent-blue); }
    .nav-item i { font-size: 20px; width: 28px; text-align: center; }

    .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 30px; background-color: var(--bg-primary); transition: var(--transition); }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { background: var(--bg-secondary); border:1px solid var(--border); border-radius: 12px; box-shadow: var(--card-shadow); }
    .section { padding: 16px; }
    .section-title { font-weight: 600; margin-bottom: 12px; }
    .input { background: var(--bg-tertiary); color: var(--text-primary); border:1px solid var(--border); border-radius:8px; padding:8px 10px; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); backdrop-filter: blur(10px); }
    .btn:hover { filter: saturate(1.2) brightness(1.05); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); filter: saturate(1); }
    .btn-secondary { background: transparent; color: var(--text-primary); border:1px solid var(--border); box-shadow: none; }
    .btn-secondary:hover { background: rgba(255,255,255,0.04); }
    .icon-btn { width: 36px; height: 36px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid var(--border); background: transparent; color: var(--text-primary); cursor:pointer; }
    .icon-btn:hover { background: rgba(255,255,255,0.05); }
    /* topbar removed */
    .kpi-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .kpi-card { padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); }
    .kpi-label { color: var(--text-tertiary); font-size: 12px; }
    .kpi-value { font-size: 20px; font-weight: 600; margin-top: 6px; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; }
    .table th { position: sticky; top: 0; background: var(--bg-secondary); z-index: 1; }
    .table tr:hover td { background: rgba(255,255,255,0.02); }
    .table.zebra tbody tr:nth-child(even) td { background: rgba(255,255,255,0.01); }
    .compact .table th, .compact .table td { padding: 6px 8px; }
    .toolbar { display:flex; gap:8px; align-items:center; }
    .kpi-spark { width: 100%; height: 46px; }
    /* Empty state */
    .empty { text-align:center; color: var(--text-secondary); padding: 24px; border:1px dashed var(--border); border-radius:12px; }
    .empty i { font-size: 28px; display:block; margin-bottom:8px; color: var(--accent-blue); }

    /* Command palette */
    .cmdpal { position: fixed; inset: 0; display:none; z-index: 1400; background: rgba(0,0,0,0.45); align-items:center; justify-content:center; }
    .cmdpal.active { display:flex; }
    .cmdpanel { width: 640px; max-width: 92%; border-radius: 12px; border:1px solid var(--border); background: var(--bg-secondary); box-shadow: var(--card-shadow); overflow:hidden; }
    .cmdinput { width:100%; padding:12px 14px; border:none; outline:none; background: var(--bg-tertiary); color: var(--text-primary); font-size:14px; border-bottom:1px solid var(--border); }
    .cmdlist { max-height: 320px; overflow:auto; }
    .cmditem { padding:10px 14px; border-bottom:1px solid var(--border); cursor:pointer; display:flex; gap:10px; align-items:center; }
    .cmditem:hover, .cmditem.active { background: rgba(42,127,255,0.12); }
    .cmditem i { color: var(--accent-blue); }
    .tab-content { display: none; animation: fadeIn 0.4s ease-out; /* height removed for natural flow */ overflow-y: auto; padding-right: 10px; position: relative; }
    .tab-content::-webkit-scrollbar { width: 6px; }
    .tab-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .tab-content.active { display: block !important; }
    .hero-rotate { transition: opacity 300ms ease, transform 300ms ease; }
    .hero-hidden { opacity: 0; transform: translateY(8px); }
  </style>
</head>
<body>
  <div class="overlay" id="loadingOverlay"><div class="spinner"></div></div>

  <div class="sidebar">
    <div class="logo">
      <i class="ti ti-brain"></i>
      <span>AI-Smart</span>
    </div>
    <div class="nav-menu">
      <div class="nav-section">
        <div class="nav-section-title"><i class="ti ti-dashboard"></i> Основное</div>
        <div class="nav-item active" data-tab="dashboard">
          <i class="ti ti-home"></i>
          <span>Главная</span>
        </div>
        <div class="nav-item" data-tab="reports">
          <i class="ti ti-file-report"></i>
          <span>Отчёты</span>
        </div>
        <div class="nav-item" data-tab="datasets">
          <i class="ti ti-database"></i>
          <span>Данные</span>
        </div>
        <div class="nav-item" data-tab="unit-economics">
          <i class="ti ti-currency-rouble"></i>
          <span>Юнит-экономика</span>
        </div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title"><i class="ti ti-settings"></i> Настройки</div>
        <div class="nav-item" id="openSettingsNav">
          <i class="ti ti-settings"></i>
          <span>Настройки</span>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <!-- topbar removed for cleaner layout -->
    <div class="tab-content active" id="dashboard">
      <div class="container">
      <div class="header">
        <h1 class="page-title">Панель управления</h1>
        <div class="user-profile" id="openSettings">
          <div class="user-avatar">А</div>
        </div>
      </div>
      <div class="dashboard-placeholder">
        <div class="greeting" id="greetingText">Добро пожаловать!</div>
        <p class="subtext hero-rotate" id="subtext">Принимайте решения на основе точной аналитики и прогнозов.</p>
      </div>
      </div>
    </div>

    <div class="tab-content" id="unit-economics">
      <div class="container">
      <div class="header">
        <h1 class="page-title">Юнит-экономика</h1>
      </div>
      <div class="file-upload card section" id="fileUploadArea">
        <div style="display:flex; gap:8px; justify-content:center; flex-wrap: wrap; margin-bottom: 8px;">
          <button class="btn" id="selectFileBtn">Выбрать файл</button>
          <button class="btn btn-secondary" id="openDirBtn">Открыть папку</button>
        </div>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" />
        <i class="ti ti-upload file-upload-icon"></i>
        <p>Нажмите, чтобы выбрать файл с данными</p>
        <small>Поддерживаемые форматы: XLSX, CSV, XLS. Или выберите папку с файлами ниже.</small>
      </div>
      <div id="fileSummary" style="color: var(--text-secondary);"></div>
      </div>
    </div>

    <div class="tab-content" id="datasets">
      <div class="container">
      <div class="header">
        <h1 class="page-title">Данные</h1>
        <div>
          <button class="btn" id="saveDatasetBtn">Сохранить текущий набор</button>
        </div>
      </div>
      <!-- simplified: import panel removed to avoid clutter -->
      <div id="datasetsContent" class="card section">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 8px;">
          <div id="datasetsListTitle" style="font-weight:600;">Наборы данных</div>
          <div class="toolbar">
            <input id="datasetsSearch" placeholder="Поиск..." class="input" />
            <button class="icon-btn" id="toggleDensity" title="Плотность"><i class="ti ti-arrows-vertical"></i></button>
          </div>
        </div>
        <div id="datasetsList" class="zebra" style="margin-bottom:16px; overflow:auto; border:1px solid var(--border); border-radius:10px;">
          <table class="table zebra" id="datasetsTable">
            <thead><tr><th>Имя набора</th><th>Дата</th><th>Строк</th><th style="width:160px">Действия</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="datasetPreview"></div>
      </div>
      </div>
    </div>

    <div class="tab-content" id="reports">
      <div class="container">
      <div class="header">
        <h1 class="page-title">Отчёты</h1>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="reportDatasetSelect" class="input"></select>
          <button class="btn" id="runReportBtn">Сгенерировать</button>
          <button class="btn" id="exportCsvBtn">Экспорт CSV</button>
          <button class="btn" id="exportXlsxBtn">Экспорт XLSX</button>
        </div>
      </div>
      <div style="display:flex; gap:16px; align-items:flex-start;">
        <div id="reportsGallery" class="card section glass" style="flex:0 0 360px;"></div>
        <div style="flex:1; display:flex; flex-direction:column; gap:12px;">
          <div id="reportKPI" class="kpi-grid" style="display:none;"></div>
          <div id="mappingPanel" class="card section glass" style="display:none;">
            <div style="font-weight:600; margin-bottom:8px;">Маппинг полей</div>
            <div id="mappingFields" style="display:grid; grid-template-columns: 260px 1fr; gap:8px;"></div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button class="btn" id="autoMapBtn">Автосопоставление</button>
              <button class="btn" id="saveMappingBtn">Сохранить маппинг</button>
            </div>
          </div>
          <div id="reportResult" class="card section glass" style="flex:1; display:none;"></div>
          <div id="reportEmpty" class="empty"><i class="ti ti-report"></i>Выберите отчёт и набор данных, затем нажмите «Сгенерировать»</div>
        </div>
      </div>
      </div>
    </div>

    <!-- Settings tab removed; using modal only -->
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Настройки</div>
        <button class="modal-close" id="closeSettings">&times;</button>
      </div>
      <div class="modal-body">
        <form class="settings-form" id="settingsForm">
          <div class="form-group">
            <label>Имя пользователя</label>
            <input type="text" id="userNameModal" placeholder="Введите имя" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="userEmailModal" placeholder="Введите email" />
          </div>
          <div class="form-group">
            <label>Тема</label>
            <div style="display: flex; gap: 10px; margin-top: 6px;">
              <button type="button" data-theme="dark" class="btn" style="padding: 6px 12px; font-size: 12px;">Тёмная</button>
              <button type="button" data-theme="light" class="btn" style="padding: 6px 12px; font-size: 12px;">Светлая</button>
            </div>
          </div>
          <div class="form-group">
            <label>Цвет акцента</label>
            <div class="color-picker">
              <input type="color" id="colorPickerModal" value="#2a7fff" />
              <div class="color-preview" id="colorPreviewModal"></div>
              <span id="colorValueModal">#2a7fff</span>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" style="background: var(--bg-tertiary); color: var(--text-primary);" id="cancelSettings">Отмена</button>
        <button class="btn" id="saveSettingsModal">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Command palette -->
  <div class="cmdpal" id="cmdpal">
    <div class="cmdpanel">
      <input class="cmdinput" id="cmdInput" placeholder="Что вы хотите сделать? (например, Перейти в Данные)"/>
      <div class="cmdlist" id="cmdList"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    let currentData = null;
    let activeChart = null;
    const appSettings = { userName: 'Пользователь', userEmail: '', theme: 'dark', accentColor: '#2a7fff' };

    if (!window.electronAPI) {
      window.electronAPI = {
        getSetting: async (key) => localStorage.getItem(key),
        setSetting: async (key, value) => { localStorage.setItem(key, value); return true; },
        openFile: async () => null,
        openDirectory: async () => null,
        datasets: { list: async () => [], create: async (name, data, options) => ({ id: 'temp-id', name: name, rowsCount: data.length, createdAt: new Date() }), get: async (id) => ({ rows: [] }), rename: async () => true, delete: async () => true },
        mappings: { get: async () => ({}), set: async () => true }
      };
    }

    document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        item.classList.add('active');
        document.getElementById(item.dataset.tab).classList.add('active');
        // Ensure settings drawer is closed when switching tabs
        settingsModal.classList.remove('active');
        // breadcrumb removed with topbar
      });
    });

    function shadeColor(color, percent) {
      let R = parseInt(color.slice(1, 3), 16);
      let G = parseInt(color.slice(3, 5), 16);
      let B = parseInt(color.slice(5, 7), 16);
      R = parseInt(R * (100 + percent) / 100);
      G = parseInt(G * (100 + percent) / 100);
      B = parseInt(B * (100 + percent) / 100);
      R = (R < 255 ? R : 255).toString(16).padStart(2, '0');
      G = (G < 255 ? G : 255).toString(16).padStart(2, '0');
      B = (B < 255 ? B : 255).toString(16).padStart(2, '0');
      return `#${R}${G}${B}`;
    }

    function applyAccent(color) {
      document.documentElement.style.setProperty('--accent-blue', color);
      document.documentElement.style.setProperty('--accent-hover', shadeColor(color, 20));
      document.documentElement.style.setProperty('--accent-active', shadeColor(color, -20));
    }

    function bindColorPicker(prefix) {
      const picker = document.getElementById(`colorPicker${prefix}`);
      const preview = document.getElementById(`colorPreview${prefix}`);
      const valueEl = document.getElementById(`colorValue${prefix}`);
      if (!picker || !preview || !valueEl) return;
      preview.style.backgroundColor = picker.value;
      valueEl.textContent = picker.value;
      picker.addEventListener('input', function () {
        const color = this.value;
        preview.style.backgroundColor = color;
        valueEl.textContent = color;
        applyAccent(color);
      });
    }

    document.querySelectorAll('[data-theme]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const theme = btn.dataset.theme;
        document.body.setAttribute('data-theme', theme);
        appSettings.theme = theme;
      });
    });

    const settingsModal = document.getElementById('settingsModal');
    const openSettings = document.getElementById('openSettings');
    const openSettingsNav = document.getElementById('openSettingsNav');
    const closeSettings = document.getElementById('closeSettings');
    const cancelSettings = document.getElementById('cancelSettings');

    [openSettings, openSettingsNav, closeSettings, cancelSettings].forEach(el => {
      if (!el) return;
      el.addEventListener('click', () => {
        const shouldOpen = (el === openSettings);
        settingsModal.classList.toggle('active', shouldOpen || el === openSettingsNav);
      });
    });
    // Close on overlay click
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) settingsModal.classList.remove('active'); });
    // Close on ESC
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') settingsModal.classList.remove('active'); });
    // Global click outside drawer content
    document.addEventListener('click', (e) => {
      const content = document.querySelector('.modal-content');
      if (!content) return;
      const isDrawer = content.contains(e.target);
      const isOpenBtn = e.target.closest && e.target.closest('#openSettings, #openSettingsNav');
      if (settingsModal.classList.contains('active') && !isDrawer && !isOpenBtn) settingsModal.classList.remove('active');
    }, true);

    function getInputs(prefix) {
      return { name: document.getElementById(`userName${prefix}`), email: document.getElementById(`userEmail${prefix}`), colorValue: document.getElementById(`colorValue${prefix}`) };
    }

    async function saveSettingsFrom(prefix) {
      const { name, email, colorValue } = getInputs(prefix);
      const userName = name?.value || '';
      const userEmail = email?.value || '';
      const theme = document.body.getAttribute('data-theme') || 'dark';
      const accentColor = colorValue?.textContent || '#2a7fff';

      appSettings.userName = userName; appSettings.userEmail = userEmail; appSettings.theme = theme; appSettings.accentColor = accentColor;

      try {
        await window.electronAPI.setSetting('userName', userName);
        await window.electronAPI.setSetting('userEmail', userEmail);
        await window.electronAPI.setSetting('theme', theme);
        await window.electronAPI.setSetting('accentColor', accentColor);
      } catch (e) {}

      const avatar = document.querySelector('.user-avatar'); if (avatar && userName) avatar.textContent = userName[0].toUpperCase();
      const greeting = document.getElementById('greetingText'); if (greeting && userName) greeting.textContent = `Добро пожаловать, ${userName}!`;

      if (settingsModal.classList.contains('active')) settingsModal.classList.remove('active');
      showToast('Настройки сохранены', 'success');
    }

    const saveModalBtn = document.getElementById('saveSettingsModal'); if (saveModalBtn) saveModalBtn.addEventListener('click', () => saveSettingsFrom('Modal'));

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Ensure only the dashboard tab is active on load
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        const dash = document.getElementById('dashboard'); if (dash) dash.classList.add('active');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        const dashBtn = document.querySelector('.nav-item[data-tab="dashboard"]'); if (dashBtn) dashBtn.classList.add('active');
        // Hide report blocks initially
        const rr = document.getElementById('reportResult'); if (rr) rr.style.display='none';
        const rk = document.getElementById('reportKPI'); if (rk) rk.style.display='none';
        const re = document.getElementById('reportEmpty'); if (re) re.style.display='block';

        // Start hero phrases rotation
        const phrases = [
          'Принимайте решения на основе точной аналитики и прогнозов.',
          'Свяжите данные и отчёты в один поток — быстро и прозрачно.',
          'Экономьте время: автоматизируйте отчёты и выгрузки в один клик.',
          'Настройте интерфейс и метрики под вашу команду.'
        ];
        const sub = document.getElementById('subtext');
        let idx = 0;
        function nextPhrase() {
          if (!sub) return;
          sub.classList.add('hero-hidden');
          setTimeout(() => {
            idx = (idx + 1) % phrases.length;
            sub.textContent = phrases[idx];
            sub.classList.remove('hero-hidden');
          }, 300);
        }
        setInterval(nextPhrase, 4500);

        const savedUserName = await window.electronAPI.getSetting('userName');
        const savedUserEmail = await window.electronAPI.getSetting('userEmail');
        const savedTheme = await window.electronAPI.getSetting('theme');
        const savedColor = await window.electronAPI.getSetting('accentColor');
        if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
        if (savedColor) applyAccent(savedColor);
        const setBgIfExists = (id, val) => { const el = document.getElementById(id); if (el) el.style.backgroundColor = val; };
        const setTextIfExists = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        if (savedUserName) { setTextIfExists('userNamePage', savedUserName); setTextIfExists('userNameModal', savedUserName); const avatar = document.querySelector('.user-avatar'); if (avatar) avatar.textContent = savedUserName[0].toUpperCase(); const greeting = document.getElementById('greetingText'); if (greeting) greeting.textContent = `Добро пожаловать, ${savedUserName}!`; }
        if (savedUserEmail) { setTextIfExists('userEmailPage', savedUserEmail); setTextIfExists('userEmailModal', savedUserEmail); }
        const color = savedColor || '#2a7fff'; ['Page', 'Modal'].forEach(prefix => { setTextIfExists(`colorValue${prefix}`, color); setBgIfExists(`colorPreview${prefix}`, color); });
        bindColorPicker('Modal');
      } catch {}
    });

    // Toasts
    const toastRoot = document.createElement('div'); toastRoot.className = 'toast-root'; document.body.appendChild(toastRoot);
    function showToast(text, type = 'info') { const el = document.createElement('div'); el.className = `toast ${type}`; el.textContent = text; toastRoot.appendChild(el); setTimeout(() => el.remove(), 3000); }

    // Loader overlay
    const overlay = document.getElementById('loadingOverlay');
    const showLoading = () => overlay.classList.add('active');
    const hideLoading = () => overlay.classList.remove('active');

    // Drag & drop import
    const uploadArea = document.getElementById('fileUploadArea');
    if (uploadArea) {
      ['dragenter','dragover'].forEach(ev => uploadArea.addEventListener(ev, e => { e.preventDefault(); uploadArea.style.borderColor = 'var(--accent-blue)'; }));
      ['dragleave','drop'].forEach(ev => uploadArea.addEventListener(ev, e => { e.preventDefault(); uploadArea.style.borderColor = 'var(--border)'; }));
      uploadArea.addEventListener('drop', async (e) => {
        const f = e.dataTransfer.files?.[0]; if (!f) return;
        try {
          showLoading();
          const name = f.name; const ext = name.split('.').pop().toLowerCase();
          if (ext === 'csv') { const text = await f.text(); const wb = XLSX.read(text, { type: 'string' }); currentData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: null }); }
          else { const buf = await f.arrayBuffer(); const wb = XLSX.read(buf, { type: 'array' }); currentData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: null }); }
          const summary = document.getElementById('fileSummary'); if (summary) summary.textContent = `Файл «${name}» загружен: ${currentData.length || 0} строк.`;
          showToast('Файл загружен', 'success');
        } catch (err) { showToast('Ошибка загрузки файла: ' + err.message, 'error'); } finally { hideLoading(); }
      });
    }

    // Explicit file input
    const selectFileBtn = document.getElementById('selectFileBtn'); const fileInput = document.getElementById('fileInput');
    if (selectFileBtn && fileInput) {
      selectFileBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); fileInput.click(); });
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0]; if (!file) return;
        const name = file.name; const ext = name.split('.').pop().toLowerCase();
        try {
          showLoading();
          if (ext === 'csv') { const text = await file.text(); const wb = XLSX.read(text, { type: 'string' }); currentData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: null }); }
          else { const buf = await file.arrayBuffer(); const wb = XLSX.read(buf, { type: 'array' }); currentData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: null }); }
          const summary = document.getElementById('fileSummary'); if (summary) summary.textContent = `Файл «${name}» загружен: ${currentData.length || 0} строк.`;
          showToast('Файл загружен', 'success');
        } catch (err) { showToast('Ошибка чтения файла: ' + err.message, 'error'); } finally { fileInput.value = ''; hideLoading(); }
      });
    }

    // Open directory (Electron)
    const openDirBtn = document.getElementById('openDirBtn');
    if (openDirBtn) {
      openDirBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        try {
          showLoading();
          const files = await window.electronAPI.openDirectory();
          if (!files || files.length === 0) return;
          let totalRows = 0; let totalFiles = 0; const previews = [];
          files.forEach((f) => { let wb; if (f.ext === 'csv') { const csvText = atob(f.data); wb = XLSX.read(csvText, { type: 'string' }); } else { wb = XLSX.read(f.data, { type: 'base64' }); } const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: null }); totalFiles += 1; totalRows += rows.length; previews.push(`${f.name}: ${rows.length}`); });
          currentData = { filesCount: totalFiles, rowsCount: totalRows };
          const summary = document.getElementById('fileSummary'); if (summary) summary.textContent = `Загружено файлов: ${totalFiles}, суммарно строк: ${totalRows}. (${previews.slice(0, 5).join('; ')}${previews.length > 5 ? '; …' : ''})`;
          showToast('Файлы загружены', 'success');
        } catch (err) { showToast('Ошибка: ' + err.message, 'error'); } finally { hideLoading(); }
      });
    }

    // Datasets UI
    async function renderDatasets() {
      const table = document.getElementById('datasetsTable'); const tbody = table?.querySelector('tbody'); const prevEl = document.getElementById('datasetPreview'); const q = (document.getElementById('datasetsSearch')?.value || '').trim().toLowerCase();
      if (!tbody || !prevEl) return;
      let items = await window.electronAPI.datasets.list();
      if (q) items = items.filter(i => i.name.toLowerCase().includes(q));
      if (!items || items.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="color:var(--text-secondary)">Нет сохранённых наборов данных</td></tr>'; prevEl.innerHTML=''; return; }
      tbody.innerHTML = items.map(i => `<tr data-id="${i.id}"><td>${i.name}</td><td>${new Date(i.createdAt).toLocaleString()}</td><td>${i.rowsCount}</td><td><div style=\"display:flex; gap:6px;\"><button class=\"icon-btn\" title=\"Предпросмотр\" data-action=\"preview\"><i class=\"ti ti-eye\"></i></button><button class=\"icon-btn\" title=\"Переименовать\" data-action=\"rename\"><i class=\"ti ti-pencil\"></i></button><button class=\"icon-btn\" title=\"Удалить\" data-action=\"delete\" style=\"border-color:#3b1f1f; color:#ff6b6b\"><i class=\"ti ti-trash\"></i></button></div></td></tr>`).join('');
      tbody.querySelectorAll('[data-action]')?.forEach(btn => {
        btn.addEventListener('click', async () => {
          const row = btn.closest('tr'); const id = row.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if (action === 'preview') { const data = await window.electronAPI.datasets.get(id); const rows = data?.rows || []; prevEl.innerHTML = renderTable(rows.slice(0, 100)); }
          else if (action === 'rename') { const newName = prompt('Новое имя набора:'); if (!newName) return; await window.electronAPI.datasets.rename(id, newName); showToast('Набор переименован', 'success'); renderDatasets(); }
          else if (action === 'delete') { if (!confirm('Удалить набор данных?')) return; await window.electronAPI.datasets.delete(id); showToast('Набор удалён', 'success'); renderDatasets(); }
        });
      });
    }

    function renderTable(rows) {
      if (!rows || rows.length === 0) return '<div style="color:var(--text-secondary)">Пусто</div>';
      const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
      const thead = `<tr>${cols.map(c => `<th style=\"text-align:left; padding:8px; border-bottom:1px solid var(--border)\">${c}</th>`).join('')}</tr>`;
      const tbody = rows.map(r => `<tr>${cols.map(c => `<td style=\"padding:8px; border-bottom:1px solid var(--border)\">${r[c] ?? ''}</td>`).join('')}</tr>`).join('');
      return `<div style=\"overflow:auto; border:1px solid var(--border); border-radius:8px;\"><table style=\"border-collapse:collapse; min-width:600px; width:100%\">${thead}${tbody}</table></div>`;
    }

    const saveDatasetBtn = document.getElementById('saveDatasetBtn');
    if (saveDatasetBtn) {
      saveDatasetBtn.addEventListener('click', async () => {
        if (!currentData || !currentData.length) { showToast('Нет данных для сохранения', 'error'); return; }
        const name = prompt('Имя набора данных:', 'Новый набор'); if (!name) return;
        showLoading();
        try { await window.electronAPI.datasets.create(name, currentData, { from: 'import' }); showToast('Набор сохранён', 'success'); renderDatasets(); }
        catch (e) { showToast('Ошибка сохранения набора', 'error'); }
        finally { hideLoading(); }
      });
    }

    document.querySelector('[data-tab="datasets"]').addEventListener('click', () => { setTimeout(renderDatasets, 0); });
    const datasetsSearch = document.getElementById('datasetsSearch'); if (datasetsSearch) datasetsSearch.addEventListener('input', () => renderDatasets());
    const toggleDensityBtn = document.getElementById('toggleDensity'); if (toggleDensityBtn) toggleDensityBtn.addEventListener('click', ()=>{ const content = document.getElementById('datasetsContent'); content?.classList.toggle('compact'); });

    // Reports
    const reportsRegistry = [
      { id: 'summary-basic', name: 'Сводка по данным', description: 'Количество строк и колонок, список полей', requiredFields: [], compute: (rows) => { const rowsCount = rows.length; const fields = Array.from(new Set(rows.flatMap(r => Object.keys(r)))); return { summary: { rowsCount, columnsCount: fields.length }, rows: fields.map(f => ({ field: f })) }; } },
      { id: 'unit-mock', name: 'Юнит-экономика (черновик)', description: 'Пример отчёта с маппингом: Цена, Себестоимость, Комиссия, Логистика', requiredFields: ['price', 'cost', 'commission', 'logistics'], compute: (rows, mapping) => { const mapped = (row, key) => row[mapping[key] || key]; const result = rows.map(r => { const price = Number(mapped(r, 'price')) || 0; const cost = Number(mapped(r, 'cost')) || 0; const commission = Number(mapped(r, 'commission')) || 0; const logistics = Number(mapped(r, 'logistics')) || 0; const margin = price - cost - commission - logistics; const marginPct = price ? (margin / price) * 100 : 0; return { price, cost, commission, logistics, margin, marginPct: Number(marginPct.toFixed(2)) }; }); return { summary: null, rows: result }; } }
    ];

    let selectedReportId = reportsRegistry[0]?.id; let currentReportRows = [];

    async function renderReports() {
      const gallery = document.getElementById('reportsGallery');
      gallery.innerHTML = reportsRegistry.map(r => `
        <div data-report-id="${r.id}" style="border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:10px; cursor:pointer; background: var(--bg-secondary);">
          <div style="font-weight:600; margin-bottom:6px;">${r.name}</div>
          <div style="color:var(--text-secondary); font-size:13px;">${r.description}</div>
        </div>
      `).join('');
      gallery.querySelectorAll('[data-report-id]').forEach(card => { card.addEventListener('click', async () => { selectedReportId = card.getAttribute('data-report-id'); gallery.querySelectorAll('[data-report-id]').forEach(c => c.style.outline = 'none'); card.style.outline = '2px solid var(--accent-blue)'; await updateMappingPanel(); await loadExistingMapping(); const rr=document.getElementById('reportResult'); const rk=document.getElementById('reportKPI'); const re=document.getElementById('reportEmpty'); if (rr) rr.style.display='none'; if (rk) rk.style.display='none'; if (re) re.style.display='block'; }); });

      const select = document.getElementById('reportDatasetSelect'); const items = await window.electronAPI.datasets.list(); select.innerHTML = items.map(i => `<option value="${i.id}">${i.name} (${i.rowsCount})</option>`).join('');
      await updateMappingPanel();
      select.addEventListener('change', async () => { await updateMappingPanel(); await loadExistingMapping(); const rr=document.getElementById('reportResult'); const rk=document.getElementById('reportKPI'); const re=document.getElementById('reportEmpty'); if (rr) rr.style.display='none'; if (rk) rk.style.display='none'; if (re) re.style.display='block'; });
    }

    async function getAvailableFieldsForSelectedDataset() {
      const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value;
      const data = await window.electronAPI.datasets.get(datasetId);
      const rows = data?.rows || [];
      return Array.from(new Set(rows.flatMap(r => Object.keys(r))));
    }

    async function updateMappingPanel() {
      const report = reportsRegistry.find(r => r.id === selectedReportId); const panel = document.getElementById('mappingPanel'); const fieldsWrap = document.getElementById('mappingFields'); if (!report) return;
      if (report.requiredFields && report.requiredFields.length > 0) {
        panel.style.display = 'block';
        const availableFields = await getAvailableFieldsForSelectedDataset();
        fieldsWrap.innerHTML = report.requiredFields.map(f => {
          const opts = ['<option value="">— выберите колонку —</option>'].concat(availableFields.map(v => `<option value="${v}">${v}</option>`)).join('');
          return `<div style=\"color:var(--text-secondary)\">${f}</div><select data-map-key=\"${f}\" class=\"input\">${opts}</select>`;
        }).join('');
      } else { panel.style.display = 'none'; fieldsWrap.innerHTML = ''; }
    }

    async function loadExistingMapping() {
      const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value; const mapping = await window.electronAPI.mappings.get(datasetId, selectedReportId);
      document.querySelectorAll('[data-map-key]')?.forEach(input => { const key = input.getAttribute('data-map-key'); if (mapping && mapping[key]) input.value = mapping[key]; });
    }

    function autoMapColumns(availableFields) {
      const synonyms = { price: ['price','цена','Стоимость продажи','Продажа'], cost: ['cost','себестоимость','Закуп','Закупка'], commission: ['commission','комиссия'], logistics: ['logistics','логистика','доставка','тариф доставки'] };
      document.querySelectorAll('[data-map-key]')?.forEach(sel => { const key = sel.getAttribute('data-map-key'); const candidates = (synonyms[key] || []).map(s => s.toLowerCase()); const match = availableFields.find(f => candidates.includes(f.toLowerCase())) || availableFields.find(f => f.toLowerCase() === key); if (match) sel.value = match; });
    }

    async function runSelectedReport() {
      const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value; if (!datasetId) { showToast('Выберите набор данных', 'error'); return; }
      const report = reportsRegistry.find(r => r.id === selectedReportId); if (!report) { showToast('Не выбран отчёт', 'error'); return; }
      showLoading();
      try {
        const data = await window.electronAPI.datasets.get(datasetId); const rows = data?.rows || [];
        let mapping = {}; if (report.requiredFields && report.requiredFields.length > 0) { document.querySelectorAll('[data-map-key]')?.forEach(sel => { const key = sel.getAttribute('data-map-key'); if (sel.value) mapping[key] = sel.value; }); }
        const result = report.compute(rows, mapping);
        currentReportRows = result.rows || [];
        const resultEl = document.getElementById('reportResult'); const kpiEl = document.getElementById('reportKPI'); const emptyEl = document.getElementById('reportEmpty');
        const summaryBlock = result.summary ? `<div style="margin-bottom:12px; color:var(--text-secondary)">Строк: ${result.summary.rowsCount}, Полей: ${result.summary.columnsCount}</div>` : '';
        resultEl.innerHTML = `${summaryBlock}${renderTable(currentReportRows.slice(0, 1000))}`;
        if (resultEl) resultEl.style.display='block'; if (emptyEl) emptyEl.style.display='none';
        // KPI header (simple)
        const kpis = [];
        if (report.id === 'unit-mock') {
          const n = currentReportRows.length || 1;
          const avgMargin = (currentReportRows.reduce((a,c)=>a+(Number(c.margin)||0),0)/n)||0;
          const avgPct = (currentReportRows.reduce((a,c)=>a+(Number(c.marginPct)||0),0)/n)||0;
          const series = currentReportRows.slice(0, 50).map(r=>Number(r.margin)||0);
          kpis.push({ label:'Записей', value:n });
          kpis.push({ label:'Средняя маржа', value: avgMargin.toFixed(0), series });
          kpis.push({ label:'Маржа, %', value: avgPct.toFixed(2)+'%', series: currentReportRows.slice(0,50).map(r=>Number(r.marginPct)||0) });
        } else if (result.summary) {
          kpis.push({ label:'Строк', value: result.summary.rowsCount });
          kpis.push({ label:'Полей', value: result.summary.columnsCount });
        }
        if (kpis.length) {
          kpiEl.style.display='grid';
          kpiEl.innerHTML = kpis.map((k,i)=>`<div class="kpi-card glass"><div class="kpi-label">${k.label}</div><div class="kpi-value">${k.value}</div>${k.series?`<canvas class="kpi-spark" id="kpiSpark${i}"></canvas>`:''}</div>`).join('');
          // render sparklines
          kpis.forEach((k,i)=>{ if (!k.series) return; const cvs = document.getElementById(`kpiSpark${i}`); if (!cvs) return; const ctx = cvs.getContext('2d'); new Chart(ctx, { type:'line', data:{ labels:k.series.map((_,idx)=>idx+1), datasets:[{ data:k.series, borderColor:'rgba(42,127,255,1)', backgroundColor:'rgba(42,127,255,0.15)', fill:true, tension:0.35, pointRadius:0 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }, tooltip:{ enabled:false } }, scales:{ x:{ display:false }, y:{ display:false } } }); });
        } else { kpiEl.style.display='none'; kpiEl.innerHTML=''; }
        renderChartIfApplicable(resultEl, currentReportRows);
        showToast('Отчёт готов', 'success');
      } catch (e) { showToast('Ошибка генерации отчёта', 'error'); } finally { hideLoading(); }
    }

    function renderChartIfApplicable(container, rows) {
      const hasMargin = rows.length && Object.prototype.hasOwnProperty.call(rows[0], 'margin');
      if (!hasMargin) return;
      const canvas = document.createElement('canvas'); canvas.height = 220; container.prepend(canvas);
      const labels = rows.slice(0, 50).map((_, i) => `#${i+1}`);
      const values = rows.slice(0, 50).map(r => Number(r.margin) || 0);
      if (activeChart) { activeChart.destroy(); }
      const tickColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') || '#9aa0a6';
      activeChart = new Chart(canvas.getContext('2d'), { type: 'bar', data: { labels, datasets: [{ label: 'Маржа', data: values, backgroundColor: 'rgba(42,127,255,0.35)', borderColor: 'rgba(42,127,255,1)', borderWidth: 1, borderRadius: 6 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: tickColor }, grid: { color: 'rgba(255,255,255,0.05)' } }, y: { ticks: { color: tickColor }, grid: { color: 'rgba(255,255,255,0.05)' } } } } });
    }

    function exportToCsv(rows) {
      if (!rows || rows.length === 0) return; const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
      const csv = [cols.join(',')].concat(rows.map(r => cols.map(c => JSON.stringify(r[c] ?? '')).join(','))).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'report.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function exportToXlsx(rows) {
      if (!rows || rows.length === 0) return; const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Report'); XLSX.writeFile(wb, 'report.xlsx');
    }

    document.getElementById('runReportBtn').addEventListener('click', runSelectedReport);
    document.getElementById('exportCsvBtn').addEventListener('click', () => exportToCsv(currentReportRows));
    document.getElementById('exportXlsxBtn').addEventListener('click', () => exportToXlsx(currentReportRows));

    const reportsTabBtn = document.querySelector('[data-tab="reports"]'); if (reportsTabBtn) { reportsTabBtn.addEventListener('click', async () => { await renderReports(); await loadExistingMapping(); }); }

    document.getElementById('autoMapBtn').addEventListener('click', async () => { const fields = await getAvailableFieldsForSelectedDataset(); autoMapColumns(fields); });
    document.getElementById('saveMappingBtn').addEventListener('click', async () => { const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value; const mapping = {}; document.querySelectorAll('[data-map-key]')?.forEach(sel => { const key = sel.getAttribute('data-map-key'); if (sel.value) mapping[key] = sel.value; }); await window.electronAPI.mappings.set(datasetId, selectedReportId, mapping); showToast('Маппинг сохранён', 'success'); });

    // Command palette implementation
    const cmdpal = document.getElementById('cmdpal');
    const cmdInput = document.getElementById('cmdInput');
    const cmdList = document.getElementById('cmdList');
    const commands = [
      { icon:'ti ti-home', label:'Перейти: Главная', run:()=>document.querySelector('[data-tab="dashboard"]').click() },
      { icon:'ti ti-database', label:'Перейти: Данные', run:()=>document.querySelector('[data-tab="datasets"]').click() },
      { icon:'ti ti-file-report', label:'Перейти: Отчёты', run:()=>document.querySelector('[data-tab="reports"]').click() },
      { icon:'ti ti-currency-rouble', label:'Перейти: Юнит-экономика', run:()=>document.querySelector('[data-tab="unit-economics"]').click() },
      { icon:'ti ti-settings', label:'Открыть настройки', run:()=>{ settingsModal.classList.add('active'); cmdpal.classList.remove('active'); } },
      { icon:'ti ti-upload', label:'Импорт: Выбрать файл (Юнит-экономика)', run:()=>{ document.querySelector('[data-tab="unit-economics"]').click(); setTimeout(()=>document.getElementById('selectFileBtn')?.click(), 100); } },
    ];
    function renderCmdList(filter=''){
      const f = filter.trim().toLowerCase();
      const rows = commands.filter(c=>!f || c.label.toLowerCase().includes(f));
      cmdList.innerHTML = rows.map((c,idx)=>`<div class="cmditem${idx===0?' active':''}" data-idx="${idx}"><i class="${c.icon}"></i><span>${c.label}</span></div>`).join('');
    }
    function openCmdPal(){ cmdpal.classList.add('active'); cmdInput.value=''; renderCmdList(); cmdInput.focus(); }
    function closeCmdPal(){ cmdpal.classList.remove('active'); }
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k') { e.preventDefault(); openCmdPal(); }
      if (e.key==='Escape') closeCmdPal();
    });
    cmdpal.addEventListener('click', (e)=>{ if (e.target===cmdpal) closeCmdPal(); });
    cmdInput.addEventListener('input', (e)=>{ renderCmdList(cmdInput.value); });
    cmdList.addEventListener('click', (e)=>{
      const item = e.target.closest('.cmditem'); if (!item) return;
      const idx = Number(item.getAttribute('data-idx'))||0;
      commands[idx].run(); closeCmdPal();
    });
    cmdInput.addEventListener('keydown', (e)=>{
      const items = Array.from(cmdList.querySelectorAll('.cmditem'));
      let active = items.findIndex(i=>i.classList.contains('active'));
      if (e.key==='ArrowDown') { e.preventDefault(); items[active]?.classList.remove('active'); active = (active+1)%items.length; items[active]?.classList.add('active'); }
      if (e.key==='ArrowUp') { e.preventDefault(); items[active]?.classList.remove('active'); active = (active-1+items.length)%items.length; items[active]?.classList.add('active'); }
      if (e.key==='Enter') { e.preventDefault(); const idx = Number(items[active]?.getAttribute('data-idx'))||0; commands[idx].run(); closeCmdPal(); }
    });
  </script>
</body>
</html>