<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI-Smart — Платформа для менеджеров Яндекс Маркета</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" />
  <style>
    :root {
      --bg-primary: #11131a;
      --bg-secondary: #1e2128;
      --bg-tertiary: #2a2e37;
      --bg-quaternary: #3a3f4b;
      --text-primary: #e6e6e6;
      --text-secondary: #a0a0a0;
      --text-tertiary: #777;
      --accent-blue: #2a7fff;
      --accent-hover: #3b8cff;
      --accent-active: #1c6ed1;
      --success: #22c55e;
      --error: #ef4444;
      --border: #3a3f4b;
      --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      --glow: 0 0 15px rgba(42, 127, 255, 0.4);
      --radius-md: 8px;
      --radius-lg: 12px;
      --transition: 0.3s ease;
      --sidebar-width: 260px;
    }

    [data-theme="light"] {
      --bg-primary: #f7f8fa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f3f5;
      --bg-quaternary: #e9ecef;
      --text-primary: #11131a;
      --text-secondary: #4a4a4a;
      --text-tertiary: #6b7280;
      --border: #d1d5db;
      --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      display: flex; min-height: 100vh; overflow: hidden;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border-right: 1px solid var(--border);
      padding: 20px 0; display: flex; flex-direction: column; height: 100vh;
      position: fixed; left: 0; top: 0; transition: var(--transition); z-index: 100;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .logo { padding: 0 20px 20px; font-size: 20px; font-weight: 700; color: white; display: flex; align-items: center; gap: 12px; }
    .logo span { color: var(--accent-blue); }

    .nav-menu { flex: 1; padding: 10px 0; }
    .nav-section { margin-bottom: 30px; }
    .nav-section-title { color: var(--text-tertiary); font-size: 12px; font-weight: 600; text-transform: uppercase; padding: 0 20px 10px; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
    .nav-section-title i { color: var(--accent-blue); font-size: 14px; }

    .nav-item { display: flex; align-items: center; padding: 12px 20px; color: var(--text-secondary); cursor: pointer; transition: var(--transition); gap: 16px; font-weight: 500; border-radius: 8px; margin: 0 10px; }
    .nav-item:hover { background: rgba(42, 127, 255, 0.1); color: var(--text-primary); }
    .nav-item.active { background: rgba(42, 127, 255, 0.15); color: var(--accent-blue); }
    .nav-item i { font-size: 20px; width: 28px; text-align: center; }

    .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 30px; background-color: var(--bg-primary); transition: var(--transition); }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .page-title { font-size: 28px; font-weight: 600; background: linear-gradient(90deg, var(--text-primary), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    .user-profile { display: flex; align-items: center; gap: 12px; background-color: var(--bg-tertiary); padding: 8px 14px; border-radius: 10px; cursor: pointer; }
    .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-blue), #1c6ed1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; box-shadow: var(--glow); }

    .tab-content { display: none; animation: fadeIn 0.4s ease-out; height: calc(100vh - 140px); overflow-y: auto; padding-right: 10px; }
    .tab-content::-webkit-scrollbar { width: 6px; }
    .tab-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

    .dashboard-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: var(--text-secondary); padding: 0 20px; }
    .greeting { font-size: 24px; font-weight: 500; margin-bottom: 16px; color: var(--text-primary); background: linear-gradient(90deg, var(--text-primary), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .subtext { color: var(--text-tertiary); max-width: 500px; }

    .file-upload { border: 2px dashed var(--border); padding: 40px 20px; border-radius: var(--radius-lg); text-align: center; margin-bottom: 24px; background: rgba(42, 127, 255, 0.03); cursor: pointer; transition: border-color .2s; }
    .file-upload-icon { font-size: 40px; color: var(--accent-blue); margin-bottom: 12px; }
    .file-upload p { color: var(--text-secondary); margin: 8px 0; }

    .btn { padding: 12px 20px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-hover)); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; font-weight: 500; transition: var(--transition); font-size: 14px; display: inline-flex; align-items: center; gap: 8px; box-shadow: var(--glow); }

    /* Toasts */
    .toast-root { position: fixed; right: 20px; bottom: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 2000; }
    .toast { padding: 10px 12px; border-radius: 8px; color: #fff; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(8px); animation: toastIn .2s forwards; }
    .toast.info { background: #3b82f6; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--error); }
    @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }

    /* Loader overlay */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 1500; }
    .overlay.active { display: flex; }
    .spinner { width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="overlay" id="loadingOverlay"><div class="spinner"></div></div>

  <div class="sidebar">
    <div class="logo">
      <i class="ti ti-brain"></i>
      <span>AI-Smart</span>
    </div>
    <div class="nav-menu">
      <div class="nav-section">
        <div class="nav-section-title"><i class="ti ti-dashboard"></i> Основное</div>
        <div class="nav-item active" data-tab="dashboard">
          <i class="ti ti-home"></i>
          <span>Главная</span>
        </div>
        <div class="nav-item" data-tab="reports">
          <i class="ti ti-file-report"></i>
          <span>Отчёты</span>
        </div>
        <div class="nav-item" data-tab="datasets">
          <i class="ti ti-database"></i>
          <span>Данные</span>
        </div>
        <div class="nav-item" data-tab="unit-economics">
          <i class="ti ti-currency-rouble"></i>
          <span>Юнит-экономика</span>
        </div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title"><i class="ti ti-settings"></i> Настройки</div>
        <div class="nav-item" data-tab="settings">
          <i class="ti ti-settings"></i>
          <span>Настройки</span>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="tab-content active" id="dashboard">
      <div class="header">
        <h1 class="page-title">Панель управления</h1>
        <div class="user-profile" id="openSettings">
          <div class="user-avatar">А</div>
        </div>
      </div>
      <div class="dashboard-placeholder">
        <div class="greeting" id="greetingText">Добро пожаловать!</div>
        <p class="subtext" id="subtext">Принимайте решения на основе точной аналитики и прогнозов.</p>
      </div>
    </div>

    <div class="tab-content" id="unit-economics">
      <div class="header">
        <h1 class="page-title">Юнит-экономика</h1>
      </div>
      <div class="file-upload" id="fileUploadArea">
        <div style="display:flex; gap:8px; justify-content:center; flex-wrap: wrap; margin-bottom: 8px;">
          <button class="btn" id="selectFileBtn">Выбрать файл</button>
          <button class="btn" id="openDirBtn">Открыть папку с файлами</button>
        </div>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" />
        <i class="ti ti-upload file-upload-icon"></i>
        <p>Нажмите, чтобы выбрать файл с данными</p>
        <small>Поддерживаемые форматы: XLSX, CSV, XLS. Или выберите папку с файлами ниже.</small>
      </div>
      <div id="fileSummary" style="color: var(--text-secondary);"></div>
    </div>

    <div class="tab-content" id="datasets">
      <div class="header">
        <h1 class="page-title">Данные</h1>
        <div>
          <button class="btn" id="saveDatasetBtn">Сохранить текущий набор</button>
        </div>
      </div>
      <div id="datasetsContent">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 8px;">
          <div id="datasetsListTitle" style="font-weight:600;">Наборы данных</div>
          <input id="datasetsSearch" placeholder="Поиск..." style="background: var(--bg-tertiary); color: var(--text-primary); border:1px solid var(--border); border-radius:8px; padding:8px 10px;" />
        </div>
        <div id="datasetsList" style="margin-bottom:16px;"></div>
        <div id="datasetPreview"></div>
      </div>
    </div>

    <div class="tab-content" id="reports">
      <div class="header">
        <h1 class="page-title">Отчёты</h1>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="reportDatasetSelect" style="background: var(--bg-tertiary); color: var(--text-primary); border:1px solid var(--border); border-radius:8px; padding:8px 10px;"></select>
          <button class="btn" id="runReportBtn">Сгенерировать</button>
          <button class="btn" id="exportCsvBtn">Экспорт CSV</button>
          <button class="btn" id="exportXlsxBtn">Экспорт XLSX</button>
        </div>
      </div>
      <div style="display:flex; gap:16px; align-items:flex-start;">
        <div id="reportsGallery" style="flex:0 0 360px;"></div>
        <div style="flex:1; display:flex; flex-direction:column; gap:12px;">
          <div id="mappingPanel" style="border:1px solid var(--border); border-radius:10px; padding:12px; background: var(--bg-secondary); display:none;">
            <div style="font-weight:600; margin-bottom:8px;">Маппинг полей</div>
            <div id="mappingFields" style="display:grid; grid-template-columns: 240px 1fr; gap:8px;"></div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button class="btn" id="autoMapBtn">Автосопоставление</button>
              <button class="btn" id="saveMappingBtn">Сохранить маппинг</button>
            </div>
          </div>
          <div id="reportResult" style="flex:1;"></div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="settings">
      <div class="header">
        <h1 class="page-title">Настройки</h1>
      </div>
      <div class="settings-form">
        <div class="form-group">
          <label>Имя пользователя</label>
          <input type="text" id="userNamePage" placeholder="Введите имя" />
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="userEmailPage" placeholder="Введите email" />
        </div>
        <div class="form-group">
          <label>Тема</label>
          <div style="display: flex; gap: 10px; margin-top: 6px;">
            <button type="button" data-theme="dark" class="btn" style="padding: 6px 12px; font-size: 12px;">Тёмная</button>
            <button type="button" data-theme="light" class="btn" style="padding: 6px 12px; font-size: 12px;">Светлая</button>
          </div>
        </div>
        <div class="form-group">
          <label>Цвет акцента</label>
          <div class="color-picker">
            <input type="color" id="colorPickerPage" value="#2a7fff" />
            <div class="color-preview" id="colorPreviewPage"></div>
            <span id="colorValuePage">#2a7fff</span>
          </div>
        </div>
        <button class="btn" id="saveSettingsPage" style="margin-top: 20px;">Сохранить</button>
      </div>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Настройки</div>
        <button class="modal-close" id="closeSettings">&times;</button>
      </div>
      <div class="modal-body">
        <form class="settings-form" id="settingsForm">
          <div class="form-group">
            <label>Имя пользователя</label>
            <input type="text" id="userNameModal" placeholder="Введите имя" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="userEmailModal" placeholder="Введите email" />
          </div>
          <div class="form-group">
            <label>Тема</label>
            <div style="display: flex; gap: 10px; margin-top: 6px;">
              <button type="button" data-theme="dark" class="btn" style="padding: 6px 12px; font-size: 12px;">Тёмная</button>
              <button type="button" data-theme="light" class="btn" style="padding: 6px 12px; font-size: 12px;">Светлая</button>
            </div>
          </div>
          <div class="form-group">
            <label>Цвет акцента</label>
            <div class="color-picker">
              <input type="color" id="colorPickerModal" value="#2a7fff" />
              <div class="color-preview" id="colorPreviewModal"></div>
              <span id="colorValueModal">#2a7fff</span>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" style="background: var(--bg-tertiary); color: var(--text-primary);" id="cancelSettings">Отмена</button>
        <button class="btn" id="saveSettingsModal">Сохранить</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    let currentData = null;
    let activeChart = null;
    const appSettings = { userName: 'Пользователь', userEmail: '', theme: 'dark', accentColor: '#2a7fff' };

    if (!window.electronAPI) {
      window.electronAPI = {
        getSetting: async (key) => localStorage.getItem(key),
        setSetting: async (key, value) => { localStorage.setItem(key, value); return true; },
        openFile: async () => null,
        openDirectory: async () => null,
        datasets: { list: async () => [], create: async (name, data, options) => ({ id: 'temp-id', name: name, rowsCount: data.length, createdAt: new Date() }), get: async (id) => ({ rows: [] }), rename: async () => true, delete: async () => true },
        mappings: { get: async () => ({}), set: async () => true }
      };
    }

    document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        item.classList.add('active');
        document.getElementById(item.dataset.tab).classList.add('active');
      });
    });

    function shadeColor(color, percent) {
      let R = parseInt(color.slice(1, 3), 16);
      let G = parseInt(color.slice(3, 5), 16);
      let B = parseInt(color.slice(5, 7), 16);
      R = parseInt(R * (100 + percent) / 100);
      G = parseInt(G * (100 + percent) / 100);
      B = parseInt(B * (100 + percent) / 100);
      R = (R < 255 ? R : 255).toString(16).padStart(2, '0');
      G = (G < 255 ? G : 255).toString(16).padStart(2, '0');
      B = (B < 255 ? B : 255).toString(16).padStart(2, '0');
      return `#${R}${G}${B}`;
    }

    function applyAccent(color) {
      document.documentElement.style.setProperty('--accent-blue', color);
      document.documentElement.style.setProperty('--accent-hover', shadeColor(color, 20));
      document.documentElement.style.setProperty('--accent-active', shadeColor(color, -20));
    }

    function bindColorPicker(prefix) {
      const picker = document.getElementById(`colorPicker${prefix}`);
      const preview = document.getElementById(`colorPreview${prefix}`);
      const valueEl = document.getElementById(`colorValue${prefix}`);
      if (!picker || !preview || !valueEl) return;
      preview.style.backgroundColor = picker.value;
      valueEl.textContent = picker.value;
      picker.addEventListener('input', function () {
        const color = this.value;
        preview.style.backgroundColor = color;
        valueEl.textContent = color;
        applyAccent(color);
      });
    }

    document.querySelectorAll('[data-theme]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const theme = btn.dataset.theme;
        document.body.setAttribute('data-theme', theme);
        appSettings.theme = theme;
      });
    });

    const settingsModal = document.getElementById('settingsModal');
    const openSettings = document.getElementById('openSettings');
    const closeSettings = document.getElementById('closeSettings');
    const cancelSettings = document.getElementById('cancelSettings');

    [openSettings, closeSettings, cancelSettings].forEach(el => {
      if (!el) return;
      el.addEventListener('click', () => {
        const shouldOpen = (el === openSettings);
        settingsModal.classList.toggle('active', shouldOpen);
      });
    });

    function getInputs(prefix) {
      return { name: document.getElementById(`userName${prefix}`), email: document.getElementById(`userEmail${prefix}`), colorValue: document.getElementById(`colorValue${prefix}`) };
    }

    async function saveSettingsFrom(prefix) {
      const { name, email, colorValue } = getInputs(prefix);
      const userName = name?.value || '';
      const userEmail = email?.value || '';
      const theme = document.body.getAttribute('data-theme') || 'dark';
      const accentColor = colorValue?.textContent || '#2a7fff';

      appSettings.userName = userName; appSettings.userEmail = userEmail; appSettings.theme = theme; appSettings.accentColor = accentColor;

      try {
        await window.electronAPI.setSetting('userName', userName);
        await window.electronAPI.setSetting('userEmail', userEmail);
        await window.electronAPI.setSetting('theme', theme);
        await window.electronAPI.setSetting('accentColor', accentColor);
      } catch (e) {}

      const avatar = document.querySelector('.user-avatar'); if (avatar && userName) avatar.textContent = userName[0].toUpperCase();
      const greeting = document.getElementById('greetingText'); if (greeting && userName) greeting.textContent = `Добро пожаловать, ${userName}!`;

      if (settingsModal.classList.contains('active')) settingsModal.classList.remove('active');
      showToast('Настройки сохранены', 'success');
    }

    const savePageBtn = document.getElementById('saveSettingsPage'); if (savePageBtn) savePageBtn.addEventListener('click', () => saveSettingsFrom('Page'));
    const saveModalBtn = document.getElementById('saveSettingsModal'); if (saveModalBtn) saveModalBtn.addEventListener('click', () => saveSettingsFrom('Modal'));

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const savedUserName = await window.electronAPI.getSetting('userName');
        const savedUserEmail = await window.electronAPI.getSetting('userEmail');
        const savedTheme = await window.electronAPI.getSetting('theme');
        const savedColor = await window.electronAPI.getSetting('accentColor');
        if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
        if (savedColor) applyAccent(savedColor);
        const setIfExists = (id, val) => { const el = document.getElementById(id); if (el && typeof el.value !== 'undefined') el.value = val; };
        const setBgIfExists = (id, val) => { const el = document.getElementById(id); if (el) el.style.backgroundColor = val; };
        const setTextIfExists = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        if (savedUserName) { setIfExists('userNamePage', savedUserName); setIfExists('userNameModal', savedUserName); const avatar = document.querySelector('.user-avatar'); if (avatar) avatar.textContent = savedUserName[0].toUpperCase(); const greeting = document.getElementById('greetingText'); if (greeting) greeting.textContent = `Добро пожаловать, ${savedUserName}!`; }
        if (savedUserEmail) { setIfExists('userEmailPage', savedUserEmail); setIfExists('userEmailModal', savedUserEmail); }
        const color = savedColor || '#2a7fff'; ['Page', 'Modal'].forEach(prefix => { setIfExists(`colorPicker${prefix}`, color); setBgIfExists(`colorPreview${prefix}`, color); setTextIfExists(`colorValue${prefix}`, color); });
        bindColorPicker('Page'); bindColorPicker('Modal');
      } catch {}
    });

    // Toasts
    const toastRoot = document.createElement('div'); toastRoot.className = 'toast-root'; document.body.appendChild(toastRoot);
    function showToast(text, type = 'info') { const el = document.createElement('div'); el.className = `toast ${type}`; el.textContent = text; toastRoot.appendChild(el); setTimeout(() => el.remove(), 3000); }

    // Loader overlay
    const overlay = document.getElementById('loadingOverlay');
    const showLoading = () => overlay.classList.add('active');
    const hideLoading = () => overlay.classList.remove('active');

    // Drag & drop import
    const uploadArea = document.getElementById('fileUploadArea');
    if (uploadArea) {
      ['dragenter','dragover'].forEach(ev => uploadArea.addEventListener(ev, e => { e.preventDefault(); uploadArea.style.borderColor = 'var(--accent-blue)'; }));
      ['dragleave','drop'].forEach(ev => uploadArea.addEventListener(ev, e => { e.preventDefault(); uploadArea.style.borderColor = 'var(--border)'; }));
      uploadArea.addEventListener('drop', async (e) => {
        const f = e.dataTransfer.files?.[0]; if (!f) return;
        try {
          showLoading();
          const name = f.name; const ext = name.split('.').pop().toLowerCase();
          if (ext === 'csv') { const text = await f.text(); const wb = XLSX.read(text, { type: 'string' }); currentData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: null }); }
          else { const buf = await f.arrayBuffer(); const wb = XLSX.read(buf, { type: 'array' }); currentData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: null }); }
          const summary = document.getElementById('fileSummary'); if (summary) summary.textContent = `Файл «${name}» загружен: ${currentData.length || 0} строк.`;
          showToast('Файл загружен', 'success');
        } catch (err) { showToast('Ошибка загрузки файла: ' + err.message, 'error'); } finally { hideLoading(); }
      });
    }

    // Explicit file input
    const selectFileBtn = document.getElementById('selectFileBtn'); const fileInput = document.getElementById('fileInput');
    if (selectFileBtn && fileInput) {
      selectFileBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); fileInput.click(); });
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0]; if (!file) return;
        const name = file.name; const ext = name.split('.').pop().toLowerCase();
        try {
          showLoading();
          if (ext === 'csv') { const text = await file.text(); const wb = XLSX.read(text, { type: 'string' }); currentData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: null }); }
          else { const buf = await file.arrayBuffer(); const wb = XLSX.read(buf, { type: 'array' }); currentData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: null }); }
          const summary = document.getElementById('fileSummary'); if (summary) summary.textContent = `Файл «${name}» загружен: ${currentData.length || 0} строк.`;
          showToast('Файл загружен', 'success');
        } catch (err) { showToast('Ошибка чтения файла: ' + err.message, 'error'); } finally { fileInput.value = ''; hideLoading(); }
      });
    }

    // Open directory (Electron)
    const openDirBtn = document.getElementById('openDirBtn');
    if (openDirBtn) {
      openDirBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        try {
          showLoading();
          const files = await window.electronAPI.openDirectory();
          if (!files || files.length === 0) return;
          let totalRows = 0; let totalFiles = 0; const previews = [];
          files.forEach((f) => { let wb; if (f.ext === 'csv') { const csvText = atob(f.data); wb = XLSX.read(csvText, { type: 'string' }); } else { wb = XLSX.read(f.data, { type: 'base64' }); } const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: null }); totalFiles += 1; totalRows += rows.length; previews.push(`${f.name}: ${rows.length}`); });
          currentData = { filesCount: totalFiles, rowsCount: totalRows };
          const summary = document.getElementById('fileSummary'); if (summary) summary.textContent = `Загружено файлов: ${totalFiles}, суммарно строк: ${totalRows}. (${previews.slice(0, 5).join('; ')}${previews.length > 5 ? '; …' : ''})`;
          showToast('Файлы загружены', 'success');
        } catch (err) { showToast('Ошибка: ' + err.message, 'error'); } finally { hideLoading(); }
      });
    }

    // Datasets UI
    async function renderDatasets() {
      const listEl = document.getElementById('datasetsList'); const prevEl = document.getElementById('datasetPreview'); const q = (document.getElementById('datasetsSearch')?.value || '').trim().toLowerCase();
      if (!listEl || !prevEl) return;
      let items = await window.electronAPI.datasets.list();
      if (q) items = items.filter(i => i.name.toLowerCase().includes(q));
      if (!items || items.length === 0) { listEl.innerHTML = '<div style="color:var(--text-secondary)">Нет сохранённых наборов данных</div>'; prevEl.innerHTML = ''; return; }
      listEl.innerHTML = items.map(i => `
        <div data-id="${i.id}" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border:1px solid var(--border); border-radius:8px; margin-bottom:8px; background:var(--bg-secondary)">
          <div style="display:flex; gap:12px; align-items:center;">
            <i class="ti ti-database"></i>
            <div>
              <div style="font-weight:600;">${i.name}</div>
              <div style="color:var(--text-secondary); font-size:12px;">${new Date(i.createdAt).toLocaleString()} • ${i.rowsCount} строк</div>
            </div>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn" data-action="preview">Предпросмотр</button>
            <button class="btn" data-action="rename">Переименовать</button>
            <button class="btn" data-action="delete" style="background:var(--error)">Удалить</button>
          </div>
        </div>
      `).join('');

      listEl.querySelectorAll('[data-action]')?.forEach(btn => {
        btn.addEventListener('click', async () => {
          const card = btn.closest('[data-id]'); const id = card.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if (action === 'preview') { const data = await window.electronAPI.datasets.get(id); const rows = data?.rows || []; prevEl.innerHTML = renderTable(rows.slice(0, 50)); }
          else if (action === 'rename') { const newName = prompt('Новое имя набора:'); if (!newName) return; await window.electronAPI.datasets.rename(id, newName); showToast('Набор переименован', 'success'); renderDatasets(); }
          else if (action === 'delete') { if (!confirm('Удалить набор данных?')) return; await window.electronAPI.datasets.delete(id); showToast('Набор удалён', 'success'); renderDatasets(); }
        });
      });
    }

    function renderTable(rows) {
      if (!rows || rows.length === 0) return '<div style="color:var(--text-secondary)">Пусто</div>';
      const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
      const thead = `<tr>${cols.map(c => `<th style=\"text-align:left; padding:8px; border-bottom:1px solid var(--border)\">${c}</th>`).join('')}</tr>`;
      const tbody = rows.map(r => `<tr>${cols.map(c => `<td style=\"padding:8px; border-bottom:1px solid var(--border)\">${r[c] ?? ''}</td>`).join('')}</tr>`).join('');
      return `<div style=\"overflow:auto; border:1px solid var(--border); border-radius:8px;\"><table style=\"border-collapse:collapse; min-width:600px; width:100%\">${thead}${tbody}</table></div>`;
    }

    const saveDatasetBtn = document.getElementById('saveDatasetBtn');
    if (saveDatasetBtn) {
      saveDatasetBtn.addEventListener('click', async () => {
        if (!currentData || !currentData.length) { showToast('Нет данных для сохранения', 'error'); return; }
        const name = prompt('Имя набора данных:', 'Новый набор'); if (!name) return;
        showLoading();
        try { await window.electronAPI.datasets.create(name, currentData, { from: 'import' }); showToast('Набор сохранён', 'success'); renderDatasets(); }
        catch (e) { showToast('Ошибка сохранения набора', 'error'); }
        finally { hideLoading(); }
      });
    }

    document.querySelector('[data-tab="datasets"]').addEventListener('click', () => { setTimeout(renderDatasets, 0); });
    const datasetsSearch = document.getElementById('datasetsSearch'); if (datasetsSearch) datasetsSearch.addEventListener('input', () => renderDatasets());

    // Reports
    const reportsRegistry = [
      { id: 'summary-basic', name: 'Сводка по данным', description: 'Количество строк и колонок, список полей', requiredFields: [], compute: (rows) => { const rowsCount = rows.length; const fields = Array.from(new Set(rows.flatMap(r => Object.keys(r)))); return { summary: { rowsCount, columnsCount: fields.length }, rows: fields.map(f => ({ field: f })) }; } },
      { id: 'unit-mock', name: 'Юнит-экономика (черновик)', description: 'Пример отчёта с маппингом: Цена, Себестоимость, Комиссия, Логистика', requiredFields: ['price', 'cost', 'commission', 'logistics'], compute: (rows, mapping) => { const mapped = (row, key) => row[mapping[key] || key]; const result = rows.map(r => { const price = Number(mapped(r, 'price')) || 0; const cost = Number(mapped(r, 'cost')) || 0; const commission = Number(mapped(r, 'commission')) || 0; const logistics = Number(mapped(r, 'logistics')) || 0; const margin = price - cost - commission - logistics; const marginPct = price ? (margin / price) * 100 : 0; return { price, cost, commission, logistics, margin, marginPct: Number(marginPct.toFixed(2)) }; }); return { summary: null, rows: result }; } }
    ];

    let selectedReportId = reportsRegistry[0]?.id; let currentReportRows = [];

    async function renderReports() {
      const gallery = document.getElementById('reportsGallery');
      gallery.innerHTML = reportsRegistry.map(r => `
        <div data-report-id="${r.id}" style="border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:10px; cursor:pointer; background: var(--bg-secondary);">
          <div style="font-weight:600; margin-bottom:6px;">${r.name}</div>
          <div style="color:var(--text-secondary); font-size:13px;">${r.description}</div>
        </div>
      `).join('');
      gallery.querySelectorAll('[data-report-id]').forEach(card => { card.addEventListener('click', async () => { selectedReportId = card.getAttribute('data-report-id'); gallery.querySelectorAll('[data-report-id]').forEach(c => c.style.outline = 'none'); card.style.outline = '2px solid var(--accent-blue)'; updateMappingPanelVisibility(); await loadExistingMapping(); }); });

      const select = document.getElementById('reportDatasetSelect'); const items = await window.electronAPI.datasets.list(); select.innerHTML = items.map(i => `<option value="${i.id}">${i.name} (${i.rowsCount})</option>`).join(''); updateMappingPanelVisibility();
      select.addEventListener('change', async () => { await loadExistingMapping(); });
    }

    function updateMappingPanelVisibility() {
      const report = reportsRegistry.find(r => r.id === selectedReportId); const panel = document.getElementById('mappingPanel'); const fieldsWrap = document.getElementById('mappingFields'); if (!report) return;
      if (report.requiredFields && report.requiredFields.length > 0) { panel.style.display = 'block'; fieldsWrap.innerHTML = report.requiredFields.map(f => ` <div style="color:var(--text-secondary)">${f}</div> <input data-map-key="${f}" placeholder="выберите колонку" style="background: var(--bg-tertiary); color: var(--text-primary); border:1px solid var(--border); border-radius:8px; padding:8px 10px;" />`).join(''); }
      else { panel.style.display = 'none'; fieldsWrap.innerHTML = ''; }
    }

    async function loadExistingMapping() {
      const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value; const mapping = await window.electronAPI.mappings.get(datasetId, selectedReportId);
      document.querySelectorAll('[data-map-key]')?.forEach(input => { const key = input.getAttribute('data-map-key'); if (mapping && mapping[key]) input.value = mapping[key]; });
    }

    function autoMapColumns(availableFields) {
      const synonyms = { price: ['price','цена','Стоимость продажи','Продажа'], cost: ['cost','себестоимость','Закуп','Закупка'], commission: ['commission','комиссия'], logistics: ['logistics','логистика','доставка','тариф доставки'] };
      document.querySelectorAll('[data-map-key]')?.forEach(input => { const key = input.getAttribute('data-map-key'); const candidates = (synonyms[key] || []).map(s => s.toLowerCase()); const match = availableFields.find(f => candidates.includes(f.toLowerCase())) || availableFields.find(f => f.toLowerCase() === key); if (match) input.value = match; });
    }

    async function runSelectedReport() {
      const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value; if (!datasetId) { showToast('Выберите набор данных', 'error'); return; }
      const report = reportsRegistry.find(r => r.id === selectedReportId); if (!report) { showToast('Не выбран отчёт', 'error'); return; }
      showLoading();
      try {
        const data = await window.electronAPI.datasets.get(datasetId); const rows = data?.rows || [];
        let mapping = {}; if (report.requiredFields && report.requiredFields.length > 0) { document.querySelectorAll('[data-map-key]')?.forEach(input => { const key = input.getAttribute('data-map-key'); if (input.value) mapping[key] = input.value; }); }
        const result = report.compute(rows, mapping);
        currentReportRows = result.rows || [];
        const resultEl = document.getElementById('reportResult');
        const summaryBlock = result.summary ? `<div style="margin-bottom:12px; color:var(--text-secondary)">Строк: ${result.summary.rowsCount}, Полей: ${result.summary.columnsCount}</div>` : '';
        resultEl.innerHTML = `${summaryBlock}${renderTable(currentReportRows.slice(0, 1000))}`;
        renderChartIfApplicable(resultEl, currentReportRows);
        showToast('Отчёт готов', 'success');
      } catch (e) { showToast('Ошибка генерации отчёта', 'error'); } finally { hideLoading(); }
    }

    function renderChartIfApplicable(container, rows) {
      const hasMargin = rows.length && Object.prototype.hasOwnProperty.call(rows[0], 'margin');
      if (!hasMargin) return;
      const canvas = document.createElement('canvas'); canvas.height = 220; container.prepend(canvas);
      const labels = rows.slice(0, 50).map((_, i) => `#${i+1}`);
      const values = rows.slice(0, 50).map(r => Number(r.margin) || 0);
      if (activeChart) { activeChart.destroy(); }
      activeChart = new Chart(canvas.getContext('2d'), { type: 'bar', data: { labels, datasets: [{ label: 'Маржа', data: values, backgroundColor: 'rgba(42,127,255,0.4)', borderColor: 'rgba(42,127,255,1)', borderWidth: 1 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') } }, y: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') } } } } });
    }

    function exportToCsv(rows) {
      if (!rows || rows.length === 0) return; const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
      const csv = [cols.join(',')].concat(rows.map(r => cols.map(c => JSON.stringify(r[c] ?? '')).join(','))).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'report.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function exportToXlsx(rows) {
      if (!rows || rows.length === 0) return; const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Report'); XLSX.writeFile(wb, 'report.xlsx');
    }

    document.getElementById('runReportBtn').addEventListener('click', runSelectedReport);
    document.getElementById('exportCsvBtn').addEventListener('click', () => exportToCsv(currentReportRows));
    document.getElementById('exportXlsxBtn').addEventListener('click', () => exportToXlsx(currentReportRows));

    const reportsTabBtn = document.querySelector('[data-tab="reports"]'); if (reportsTabBtn) { reportsTabBtn.addEventListener('click', async () => { await renderReports(); await loadExistingMapping(); }); }

    document.getElementById('autoMapBtn').addEventListener('click', async () => { const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value; const data = await window.electronAPI.datasets.get(datasetId); const fields = Array.from(new Set((data?.rows || []).flatMap(r => Object.keys(r)))); autoMapColumns(fields); });
    document.getElementById('saveMappingBtn').addEventListener('click', async () => { const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value; const mapping = {}; document.querySelectorAll('[data-map-key]')?.forEach(input => { const key = input.getAttribute('data-map-key'); if (input.value) mapping[key] = input.value; }); await window.electronAPI.mappings.set(datasetId, selectedReportId, mapping); showToast('Маппинг сохранён', 'success'); });
  </script>
</body>
</html>