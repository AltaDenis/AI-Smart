<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI-Smart — Платформа для менеджеров Яндекс Маркета</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" />
  <style>
    :root {
      --bg-primary: #11131a;
      --bg-secondary: #1e2128;
      --bg-tertiary: #2a2e37;
      --bg-quaternary: #3a3f4b;
      --text-primary: #e6e6e6;
      --text-secondary: #a0a0a0;
      --text-tertiary: #777;
      --accent-blue: #2a7fff;
      --accent-hover: #3b8cff;
      --accent-active: #1c6ed1;
      --success: #22c55e;
      --error: #ef4444;
      --border: #3a3f4b;
      --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      --glow: 0 0 15px rgba(42, 127, 255, 0.4);
      --radius-md: 8px;
      --radius-lg: 12px;
      --transition: 0.3s ease;
      --sidebar-width: 260px;
    }

    [data-theme="light"] {
      --bg-primary: #f7f8fa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f3f5;
      --bg-quaternary: #e9ecef;
      --text-primary: #11131a;
      --text-secondary: #4a4a4a;
      --text-tertiary: #6b7280;
      --border: #d1d5db;
      --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      display: flex; min-height: 100vh; overflow: hidden;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border-right: 1px solid var(--border);
      padding: 20px 0; display: flex; flex-direction: column; height: 100vh;
      position: fixed; left: 0; top: 0; transition: var(--transition); z-index: 100;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .logo { padding: 0 20px 20px; font-size: 20px; font-weight: 700; color: white; display: flex; align-items: center; gap: 12px; }
    .logo span { color: var(--accent-blue); }

    .nav-menu { flex: 1; padding: 10px 0; }
    .nav-section { margin-bottom: 30px; }
    .nav-section-title { color: var(--text-tertiary); font-size: 12px; font-weight: 600; text-transform: uppercase; padding: 0 20px 10px; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
    .nav-section-title i { color: var(--accent-blue); font-size: 14px; }

    .nav-item { display: flex; align-items: center; padding: 12px 20px; color: var(--text-secondary); cursor: pointer; transition: var(--transition); gap: 16px; font-weight: 500; border-radius: 8px; margin: 0 10px; }
    .nav-item:hover { background: rgba(42, 127, 255, 0.1); color: var(--text-primary); }
    .nav-item.active { background: rgba(42, 127, 255, 0.15); color: var(--accent-blue); }
    .nav-item i { font-size: 20px; width: 28px; text-align: center; }

    .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 30px; background-color: var(--bg-primary); transition: var(--transition); }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { background: var(--bg-secondary); border:1px solid var(--border); border-radius: 12px; box-shadow: var(--card-shadow); }
    .section { padding: 16px; }
    .section-title { font-weight: 600; margin-bottom: 12px; }
    .input { background: var(--bg-tertiary); color: var(--text-primary); border:1px solid var(--border); border-radius:8px; padding:8px 10px; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); backdrop-filter: blur(10px); }
    .btn:hover { filter: saturate(1.2) brightness(1.05); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); filter: saturate(1); }
    .btn-secondary { background: transparent; color: var(--text-primary); border:1px solid var(--border); box-shadow: none; }
    .btn-secondary:hover { background: rgba(255,255,255,0.04); }
    .icon-btn { width: 36px; height: 36px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid var(--border); background: transparent; color: var(--text-primary); cursor:pointer; }
    .icon-btn:hover { background: rgba(255,255,255,0.05); }
    /* topbar removed */
    .kpi-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .kpi-card { padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); }
    .kpi-label { color: var(--text-tertiary); font-size: 12px; }
    .kpi-value { font-size: 20px; font-weight: 600; margin-top: 6px; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; }
    .table th { position: sticky; top: 0; background: var(--bg-secondary); z-index: 1; }
    .table tr:hover td { background: rgba(255,255,255,0.02); }
    .table.zebra tbody tr:nth-child(even) td { background: rgba(255,255,255,0.01); }
    .compact .table th, .compact .table td { padding: 6px 8px; }
    .toolbar { display:flex; gap:8px; align-items:center; }
    .kpi-spark { width: 100%; height: 46px; }
    /* Empty state */
    .empty { text-align:center; color: var(--text-secondary); padding: 24px; border:1px dashed var(--border); border-radius:12px; }
    .empty i { font-size: 28px; display:block; margin-bottom:8px; color: var(--accent-blue); }

    /* Command palette */
    .cmdpal { position: fixed; inset: 0; display:none; z-index: 1400; background: rgba(0,0,0,0.45); align-items:center; justify-content:center; }
    .cmdpal.active { display:flex; }
    .cmdpanel { width: 640px; max-width: 92%; border-radius: 12px; border:1px solid var(--border); background: var(--bg-secondary); box-shadow: var(--card-shadow); overflow:hidden; }
    .cmdinput { width:100%; padding:12px 14px; border:none; outline:none; background: var(--bg-tertiary); color: var(--text-primary); font-size:14px; border-bottom:1px solid var(--border); }
    .cmdlist { max-height: 320px; overflow:auto; }
    .cmditem { padding:10px 14px; border-bottom:1px solid var(--border); cursor:pointer; display:flex; gap:10px; align-items:center; }
    .cmditem:hover, .cmditem.active { background: rgba(42,127,255,0.12); }
    .cmditem i { color: var(--accent-blue); }
    .tab-content { display: none; animation: fadeIn 0.4s ease-out; /* height removed for natural flow */ overflow-y: auto; padding-right: 10px; position: relative; }
    .tab-content::-webkit-scrollbar { width: 6px; }
    .tab-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .tab-content.active { display: block !important; }
    .hero-rotate { transition: opacity 300ms ease, transform 300ms ease; }
    .hero-hidden { opacity: 0; transform: translateY(8px); }
    /* Premium UI additions */
    .btn { cursor: pointer; border: none; outline: none; padding: 10px 14px; border-radius: var(--radius-md); color: #fff; background: linear-gradient(180deg, var(--accent-blue), var(--accent-active)); box-shadow: 0 6px 18px rgba(42,127,255,0.25); transition: transform var(--transition), filter var(--transition), box-shadow var(--transition); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
    .header { display:flex; align-items:center; justify-content: space-between; margin-bottom: 16px; }
    .page-title { font-size: 22px; font-weight: 700; letter-spacing: 0.2px; }
    .user-profile { display:flex; align-items:center; gap:10px; cursor:pointer; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--accent-blue); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; box-shadow: var(--glow); }
    /* Loader overlay */
    .overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); z-index: 1200; }
    .overlay.active { display: flex; }
    .spinner { width: 42px; height: 42px; border: 3px solid rgba(255,255,255,0.2); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Settings modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); z-index: 1500; }
    .modal.active { display: flex; }
    .modal-content { width: 680px; max-width: 92vw; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--card-shadow); overflow: hidden; }
    .modal-header { display:flex; align-items:center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid var(--border); }
    .modal-title { font-weight: 700; }
    .modal-close { background: transparent; border: 1px solid var(--border); color: var(--text-primary); border-radius: 10px; width: 32px; height: 32px; cursor: pointer; }
    .modal-body { padding: 14px; }
    .modal-footer { display:flex; gap:8px; justify-content: flex-end; padding: 12px 14px; border-top: 1px solid var(--border); }
    .settings-form { display:grid; gap: 12px; }
    .form-group { display:grid; gap:6px; }
    .form-group label { color: var(--text-secondary); font-size: 13px; }
    .settings-form input[type="text"], .settings-form input[type="email"], .settings-form input[type="color"] { height: 36px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); padding: 0 10px; }
    .color-picker { display:flex; align-items:center; gap:10px; }
    .color-preview { width: 24px; height: 24px; border-radius: 6px; border: 1px solid var(--border); }
    /* Toasts */
    .toast-root { position: fixed; right: 16px; bottom: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 1600; }
    .toast { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; box-shadow: var(--card-shadow); animation: toastIn 180ms ease-out; }
    .toast.success { border-color: rgba(34,197,94,0.45); }
    .toast.error { border-color: rgba(239,68,68,0.45); }
    @keyframes toastIn { from { transform: translateY(6px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    /* File upload */
    .file-upload { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; border:1px dashed var(--border); border-radius: 12px; text-align:center; min-height: 160px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); }
    .file-upload-icon { font-size: 32px; color: var(--accent-blue); }
    /* Dashboard hero */
    .dashboard-placeholder { display:flex; flex-direction:column; align-items:flex-start; gap: 8px; padding: 18px; }
    .dashboard-placeholder .greeting { font-size: 18px; font-weight: 600; }
    /* Responsive */
    @media (max-width: 1200px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 860px) {
      :root { --sidebar-width: 72px; }
      .sidebar .nav-item span, .nav-section-title { display: none; }
      .main-content { margin-left: var(--sidebar-width); padding: 18px; }
      .kpi-grid { grid-template-columns: 1fr; }
    }
    /* Inputs focus */
    .input:focus, .settings-form input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(42,127,255,0.15); }
    .input.error { border-color: var(--error); box-shadow: 0 0 0 3px rgba(239,68,68,0.15); }
    /* Danger icon button */
    .icon-btn.danger { border-color:#3b1f1f; color:#ff6b6b; }
    /* Report cards */
    .report-card { border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:10px; cursor:pointer; background: var(--bg-secondary); }
    .report-card:hover { background: rgba(255,255,255,0.03); }
    .report-card.active { outline: 2px solid var(--accent-blue); }
    /* Empty blocks */
    .empty { text-align:center; color: var(--text-secondary); padding: 24px; border:1px dashed var(--border); border-radius:12px; }
    /* Skeletons */
    .skl { display:block; width: 100%; height: 12px; border-radius: 6px; background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.12), rgba(255,255,255,0.06)); background-size: 200% 100%; animation: skl 1.2s ease-in-out infinite; }
    @keyframes skl { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    /* Prevent body scroll when modal open */
    body.modal-open { overflow: hidden; }
    @keyframes float { 0% { transform: translateY(0) translateX(0); } 50% { transform: translateY(-8px) translateX(6px); } 100% { transform: translateY(0) translateX(0); } }
    /* FAB */
    .fab { position: fixed; right: 20px; bottom: 20px; width: 52px; height: 52px; border-radius: 16px; border: none; background: linear-gradient(180deg, var(--accent-blue), var(--accent-active)); color: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 28px rgba(42,127,255,0.35); cursor: pointer; z-index: 1400; }
    .fab:hover { transform: translateY(-2px); filter: saturate(1.05); }
  </style>
</head>
<body>
  <div class="overlay" id="loadingOverlay"><div class="spinner"></div></div>

  <div class="sidebar">
    <div class="logo">
      <i class="ti ti-brain"></i>
      <span>AI-Smart</span>
    </div>
    <div class="nav-menu">
      <div class="nav-section">
        <div class="nav-section-title"><i class="ti ti-dashboard"></i> Основное</div>
        <div class="nav-item active" data-tab="dashboard">
          <i class="ti ti-home"></i>
          <span>Главная</span>
        </div>
        <div class="nav-item" data-tab="reports">
          <i class="ti ti-file-report"></i>
          <span>Отчёты</span>
        </div>
        <div class="nav-item" data-tab="datasets">
          <i class="ti ti-database"></i>
          <span>Данные</span>
        </div>
        <div class="nav-item" data-tab="unit-economics">
          <i class="ti ti-currency-rouble"></i>
          <span>Юнит-экономика</span>
        </div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title"><i class="ti ti-settings"></i> Настройки</div>
        <div class="nav-item" id="openSettingsNav">
          <i class="ti ti-settings"></i>
          <span>Настройки</span>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <!-- topbar removed for cleaner layout -->
    <div class="tab-content active" id="dashboard">
      <div class="container">
      <div class="header">
        <h1 class="page-title">Панель управления</h1>
        <div class="user-profile" id="openSettings">
          <div class="user-avatar">А</div>
        </div>
      </div>
      <div class="dashboard-placeholder">
        <div class="greeting" id="greetingText">Добро пожаловать!</div>
        <p class="subtext hero-rotate" id="subtext">Принимайте решения на основе точной аналитики и прогнозов.</p>
      </div>
      <div class="hero-visual" style="position:relative; width:100%; height:260px; margin-top: 12px; overflow:hidden; border-radius:12px; border:1px solid var(--border); background: radial-gradient(1200px 400px at -10% -30%, rgba(42,127,255,0.20), rgba(42,127,255,0.0)), radial-gradient(800px 300px at 120% 120%, rgba(42,127,255,0.18), rgba(42,127,255,0.0));">
        <div class="blob" style="position:absolute; width:220px; height:220px; left:-40px; top:-40px; background: radial-gradient(circle at 30% 30%, rgba(42,127,255,0.6), rgba(42,127,255,0)); filter: blur(18px); animation: float 8s ease-in-out infinite; border-radius: 50%;"></div>
        <div class="blob" style="position:absolute; width:260px; height:260px; right:-60px; bottom:-60px; background: radial-gradient(circle at 70% 70%, rgba(42,127,255,0.45), rgba(42,127,255,0)); filter: blur(22px); animation: float 11s ease-in-out infinite reverse; border-radius: 50%;"></div>
        <div class="blob" style="position:absolute; width:140px; height:140px; right:30%; top:20%; background: radial-gradient(circle at 50% 50%, rgba(42,127,255,0.35), rgba(42,127,255,0)); filter: blur(14px); animation: float 9s ease-in-out infinite; border-radius: 50%;"></div>
        <svg width="100%" height="100%" style="position:absolute; inset:0; opacity:0.5;">
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="rgba(42,127,255,0.0)"/>
              <stop offset="50%" stop-color="rgba(42,127,255,0.45)"/>
              <stop offset="100%" stop-color="rgba(42,127,255,0.0)"/>
            </linearGradient>
          </defs>
          <circle r="2" fill="url(#g1)">
            <animateMotion dur="12s" repeatCount="indefinite" path="M-50,40 C 120,20 240,60 400,40 S 720,40 900,80"/>
          </circle>
          <circle r="2" fill="url(#g1)">
            <animateMotion dur="15s" repeatCount="indefinite" path="M-60,200 C 150,180 260,220 420,200 S 740,200 940,240"/>
          </circle>
          <circle r="2" fill="url(#g1)">
            <animateMotion dur="18s" repeatCount="indefinite" path="M-40,120 C 130,100 260,140 420,120 S 760,120 960,160"/>
          </circle>
        </svg>
        <div id="heroRotator" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;">
          <div style="text-align:center; max-width: 820px; padding: 0 16px;">
            <div id="heroTitle" style="font-size: 28px; font-weight: 800; letter-spacing: 0.2px;">AI‑Smart</div>
            <div id="heroSubtitle" style="margin-top:8px; font-size: 16px; color: var(--text-secondary);">Принимайте решения на основе точной аналитики и прогнозов.</div>
          </div>
        </div>
      </div>
      </div>
    </div>

    <div class="tab-content" id="unit-economics">
      <div class="container">
      <div class="header">
        <h1 class="page-title">Юнит-экономика</h1>
      </div>
      <div class="file-upload card section" id="fileUploadArea">
        <div style="display:flex; gap:8px; justify-content:center; flex-wrap: wrap; margin-bottom: 8px;">
          <button class="btn" id="selectFileBtn">Выбрать файл</button>
          <button class="btn btn-secondary" id="openDirBtn">Открыть папку</button>
          <button class="btn btn-secondary" id="loadToManualBtn" title="Загрузить данные в таблицу для ручного редактирования">В таблицу</button>
        </div>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" />
        <i class="ti ti-upload file-upload-icon"></i>
        <p>Нажмите, чтобы выбрать файл с данными</p>
        <small>Поддерживаемые форматы: XLSX, CSV, XLS. Или выберите папку с файлами ниже.</small>
      </div>
      <div id="fileSummary" style="color: var(--text-secondary);"></div>

      <div id="unitManualCard" class="card section" style="margin-top:12px;">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:8px;">
          <div style="font-weight:600;">Таблица расчёта (ручной ввод)</div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-secondary" id="addManualRowBtn"><i class="ti ti-plus"></i>&nbsp;Добавить строку</button>
            <button class="btn" id="computeUnitBtn"><i class="ti ti-calculator"></i>&nbsp;Рассчитать</button>
            <button class="btn" id="saveManualDatasetBtn"><i class="ti ti-database"></i>&nbsp;Сохранить как набор</button>
          </div>
        </div>
        <div style="overflow:auto; border:1px solid var(--border); border-radius:8px;">
          <table class="table zebra" id="unitManualTable" style="min-width:900px;">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Название</th>
                <th>Категория (путь)</th>
                <th>Схема</th>
                <th>Цена</th>
                <th>Себестоимость</th>
                <th style="width:40px"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="unitResult" class="card section glass" style="margin-top:12px; display:none;"></div>
      </div>
    </div>

    <div class="tab-content" id="datasets">
      <div class="container">
      <div class="header">
        <h1 class="page-title">Данные</h1>
        <div>
          <button class="btn" id="saveDatasetBtn">Сохранить текущий набор</button>
        </div>
      </div>
      <!-- simplified: import panel removed to avoid clutter -->
      <div id="datasetsContent" class="card section">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 8px;">
          <div id="datasetsListTitle" style="font-weight:600;">Наборы данных</div>
          <div class="toolbar">
            <input id="datasetsSearch" placeholder="Поиск..." class="input" />
            <button class="icon-btn" id="toggleDensity" title="Плотность"><i class="ti ti-arrows-vertical"></i></button>
          </div>
        </div>
        <div id="datasetsList" class="zebra" style="margin-bottom:16px; overflow:auto; border:1px solid var(--border); border-radius:10px;">
                     <table class="table zebra" id="datasetsTable">
            <thead><tr><th>Имя набора</th><th>Дата</th><th>Строк</th><th style="width:180px">Действия</th></tr></thead>
            <tbody>
              <tr><td colspan="4"><div class="skl"></div></td></tr>
              <tr><td colspan="4"><div class="skl" style="width:70%"></div></td></tr>
            </tbody>
          </table>
        </div>
        <div id="datasetPreview"></div>
      </div>
      </div>
    </div>

    <div class="tab-content" id="reports">
      <div class="container">
      <div class="header">
        <h1 class="page-title">Отчёты</h1>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="reportDatasetSelect" class="input"></select>
          <button class="btn" id="runReportBtn">Сгенерировать</button>
          <button class="btn" id="exportCsvBtn">Экспорт CSV</button>
          <button class="btn" id="exportXlsxBtn">Экспорт XLSX</button>
        </div>
      </div>
      <div style="display:flex; gap:16px; align-items:flex-start;">
        <div id="reportsGallery" class="card section glass" style="flex:0 0 360px;"></div>
        <div style="flex:1; display:flex; flex-direction:column; gap:12px;">
          <div id="reportKPI" class="kpi-grid" style="display:none;"></div>
          <div id="mappingPanel" class="card section glass" style="display:none;">
            <div style="font-weight:600; margin-bottom:8px;">Маппинг полей</div>
            <div id="mappingFields" style="display:grid; grid-template-columns: 260px 1fr; gap:8px;"></div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button class="btn" id="autoMapBtn">Автосопоставление</button>
              <button class="btn" id="saveMappingBtn">Сохранить маппинг</button>
            </div>
          </div>
          <div id="reportResult" class="card section glass" style="flex:1; display:none;"></div>
          <div id="reportEmpty" class="empty"><i class="ti ti-report"></i>Выберите отчёт и набор данных, затем нажмите «Сгенерировать»</div>
        </div>
      </div>
      </div>
    </div>

    <!-- Settings tab removed; using modal only -->
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Настройки</div>
        <button class="modal-close" id="closeSettings">&times;</button>
      </div>
      <div class="modal-body">
        <form class="settings-form" id="settingsForm">
          <div class="form-group">
            <label>Имя пользователя</label>
            <input type="text" id="userNameModal" placeholder="Введите имя" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="userEmailModal" placeholder="Введите email" />
          </div>
          <div class="form-group">
            <label>Тема</label>
            <div style="display: flex; gap: 10px; margin-top: 6px;">
              <button type="button" data-theme="dark" class="btn" style="padding: 6px 12px; font-size: 12px;">Тёмная</button>
              <button type="button" data-theme="light" class="btn" style="padding: 6px 12px; font-size: 12px;">Светлая</button>
            </div>
          </div>
          <div class="form-group">
            <label>Цвет акцента</label>
            <div class="color-picker">
              <input type="color" id="colorPickerModal" value="#2a7fff" />
              <div class="color-preview" id="colorPreviewModal"></div>
              <span id="colorValueModal">#2a7fff</span>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" style="background: var(--bg-tertiary); color: var(--text-primary);" id="cancelSettings">Отмена</button>
        <button class="btn" id="saveSettingsModal">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Sheet selection modal -->
  <div class="modal" id="sheetModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Выбор листа Excel</div>
        <button class="modal-close" id="closeSheetModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Лист</label>
          <select id="sheetSelect" class="input"></select>
        </div>
        <div id="sheetPreview" style="margin-top:10px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelSheet">Отмена</button>
        <button class="btn" id="applySheet">Выбрать</button>
      </div>
    </div>
  </div>

    <!-- Command palette -->
  <div class="cmdpal" id="cmdpal">
    <div class="cmdpanel">
      <input class="cmdinput" id="cmdInput" placeholder="Что вы хотите сделать? (например, Перейти в Данные)"/>
      <div class="cmdlist" id="cmdList"></div>
    </div>
  </div>

  <!-- Safety nav handler to ensure tabs always switch even if later JS fails -->
  <script>
    (function(){
      document.addEventListener('click', function(e){
        var el = e.target && e.target.closest ? e.target.closest('.nav-item[data-tab]') : null;
        if (!el) return;
        var tabs = document.querySelectorAll('.tab-content');
        for (var i=0;i<tabs.length;i++) tabs[i].classList.remove('active');
        var navs = document.querySelectorAll('.nav-item');
        for (var j=0;j<navs.length;j++) navs[j].classList.remove('active');
        el.classList.add('active');
        var t = document.getElementById(el.dataset.tab);
        if (t) t.classList.add('active');
      });
    })();
  </script>
 
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // Ensure XLSX is available before usage (polls up to timeoutMs)
    async function ensureXlsx(timeoutMs = 3000) {
      return new Promise((resolve) => {
        if (window.XLSX && XLSX?.utils) return resolve(true);
        const start = Date.now();
        const timer = setInterval(() => {
          if (window.XLSX && XLSX?.utils) {
            clearInterval(timer);
            resolve(true);
          } else if (Date.now() - start > timeoutMs) {
            clearInterval(timer);
            try { showToast('Библиотека XLSX недоступна', 'error'); } catch {}
            resolve(false);
          }
        }, 50);
      });
    }

    let currentData = null;
    let activeChart = null;
    const appSettings = { userName: 'Пользователь', userEmail: '', theme: 'dark', accentColor: '#2a7fff' };

    if (!window.electronAPI) {
      window.electronAPI = {
        getSetting: async (key) => localStorage.getItem(key),
        setSetting: async (key, value) => { localStorage.setItem(key, value); return true; },
        openFile: async () => null,
        openDirectory: async () => null,
        datasets: { list: async () => [], create: async (name, data, options) => ({ id: 'temp-id', name: name, rowsCount: data.length, createdAt: new Date() }), get: async (id) => ({ rows: [] }), rename: async () => true, delete: async () => true },
        mappings: { get: async () => ({}), set: async () => true }
      };
    }

    function shadeColor(color, percent) {
      let R = parseInt(color.slice(1, 3), 16);
      let G = parseInt(color.slice(3, 5), 16);
      let B = parseInt(color.slice(5, 7), 16);
      R = parseInt(R * (100 + percent) / 100);
      G = parseInt(G * (100 + percent) / 100);
      B = parseInt(B * (100 + percent) / 100);
      R = (R < 255 ? R : 255).toString(16).padStart(2, '0');
      G = (G < 255 ? G : 255).toString(16).padStart(2, '0');
      B = (B < 255 ? B : 255).toString(16).padStart(2, '0');
      return `#${R}${G}${B}`;
    }

    function applyAccent(color) {
      document.documentElement.style.setProperty('--accent-blue', color);
      document.documentElement.style.setProperty('--accent-hover', shadeColor(color, 20));
      document.documentElement.style.setProperty('--accent-active', shadeColor(color, -20));
    }

    function bindColorPicker(prefix) {
      const picker = document.getElementById(`colorPicker${prefix}`);
      const preview = document.getElementById(`colorPreview${prefix}`);
      const valueEl = document.getElementById(`colorValue${prefix}`);
      if (!picker || !preview || !valueEl) return;
      preview.style.backgroundColor = picker.value;
      valueEl.textContent = picker.value;
      picker.addEventListener('input', function () {
        const color = this.value;
        preview.style.backgroundColor = color;
        valueEl.textContent = color;
        applyAccent(color);
      });
    }

    document.querySelectorAll('[data-theme]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const theme = btn.dataset.theme;
        document.body.setAttribute('data-theme', theme);
        appSettings.theme = theme;
      });
    });

    const settingsModal = document.getElementById('settingsModal');
    const openSettings = document.getElementById('openSettings');
    const openSettingsNav = document.getElementById('openSettingsNav');
    const closeSettings = document.getElementById('closeSettings');
    const cancelSettings = document.getElementById('cancelSettings');

         [openSettings, openSettingsNav, closeSettings, cancelSettings].forEach(el => {
      if (!el) return;
      el.addEventListener('click', () => {
        const shouldOpen = (el === openSettings) || (el === openSettingsNav);
        settingsModal.classList.toggle('active', shouldOpen);
        document.body.classList.toggle('modal-open', shouldOpen);
      });
    });
    // Close on overlay click
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) { settingsModal.classList.remove('active'); document.body.classList.remove('modal-open'); } });
    // Close on ESC
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { settingsModal.classList.remove('active'); document.body.classList.remove('modal-open'); } });
    // Global click outside drawer content
    document.addEventListener('click', (e) => {
      const content = document.querySelector('.modal-content');
      if (!content) return;
      const isDrawer = content.contains(e.target);
      const isOpenBtn = e.target.closest && e.target.closest('#openSettings, #openSettingsNav');
      if (settingsModal.classList.contains('active') && !isDrawer && !isOpenBtn) { settingsModal.classList.remove('active'); document.body.classList.remove('modal-open'); }
    }, true);

    function getInputs(prefix) {
      return { name: document.getElementById(`userName${prefix}`), email: document.getElementById(`userEmail${prefix}`), colorValue: document.getElementById(`colorValue${prefix}`) };
    }

    async function saveSettingsFrom(prefix) {
      const { name, email, colorValue } = getInputs(prefix);
      const userName = name?.value || '';
      const userEmail = email?.value || '';
      const theme = document.body.getAttribute('data-theme') || 'dark';
      const accentColor = colorValue?.textContent || '#2a7fff';

      appSettings.userName = userName; appSettings.userEmail = userEmail; appSettings.theme = theme; appSettings.accentColor = accentColor;

      try {
        await window.electronAPI.setSetting('userName', userName);
        await window.electronAPI.setSetting('userEmail', userEmail);
        await window.electronAPI.setSetting('theme', theme);
        await window.electronAPI.setSetting('accentColor', accentColor);
      } catch (e) {}

      const avatar = document.querySelector('.user-avatar'); if (avatar && userName) avatar.textContent = userName[0].toUpperCase();
      const greeting = document.getElementById('greetingText'); if (greeting && userName) greeting.textContent = `Добро пожаловать, ${userName}!`;

      if (settingsModal.classList.contains('active')) settingsModal.classList.remove('active');
      showToast('Настройки сохранены', 'success');
    }

    const saveModalBtn = document.getElementById('saveSettingsModal'); if (saveModalBtn) saveModalBtn.addEventListener('click', () => saveSettingsFrom('Modal'));

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Ensure only the dashboard tab is active on load
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        const dash = document.getElementById('dashboard'); if (dash) dash.classList.add('active');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        const dashBtn = document.querySelector('.nav-item[data-tab="dashboard"]'); if (dashBtn) dashBtn.classList.add('active');
        // Hide report blocks initially
        const rr = document.getElementById('reportResult'); if (rr) rr.style.display='none';
        const rk = document.getElementById('reportKPI'); if (rk) rk.style.display='none';
        const re = document.getElementById('reportEmpty'); if (re) re.style.display='block';

        // Start hero phrases rotation
        const phrases = [
          'Принимайте решения на основе точной аналитики и прогнозов.',
          'Свяжите данные и отчёты в один поток — быстро и прозрачно.',
          'Экономьте время: автоматизируйте отчёты и выгрузки в один клик.',
          'Настройте интерфейс и метрики под вашу команду.'
        ];
        const sub = document.getElementById('subtext');
        let idx = 0;
        function nextPhrase() {
          if (!sub) return;
          sub.classList.add('hero-hidden');
          setTimeout(() => {
            idx = (idx + 1) % phrases.length;
            sub.textContent = phrases[idx];
            sub.classList.remove('hero-hidden');
          }, 300);
        }
        setInterval(nextPhrase, 4500);

        // Dashboard KPI calculation
        try {
          const items = await window.electronAPI.datasets.list();
          const totalDatasets = items.length;
          const totalRows = items.reduce((a,c)=> a + (c.rowsCount||0), 0);
          const avgSize = totalDatasets ? Math.round(totalRows / totalDatasets) : 0;
          const lastItem = items[0];
         } catch {}


        const savedUserName = await window.electronAPI.getSetting('userName');
        const savedUserEmail = await window.electronAPI.getSetting('userEmail');
        const savedTheme = await window.electronAPI.getSetting('theme');
        const savedColor = await window.electronAPI.getSetting('accentColor');
        if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
        if (savedColor) applyAccent(savedColor);
        const setBgIfExists = (id, val) => { const el = document.getElementById(id); if (el) el.style.backgroundColor = val; };
        const setTextIfExists = (id, val) => { const el = document.getElementById(id); if (!el) return; if ('value' in el) { el.value = val; } else { el.textContent = val; } };
        if (savedUserName) { setTextIfExists('userNamePage', savedUserName); setTextIfExists('userNameModal', savedUserName); const avatar = document.querySelector('.user-avatar'); if (avatar) avatar.textContent = savedUserName[0].toUpperCase(); const greeting = document.getElementById('greetingText'); if (greeting) greeting.textContent = `Добро пожаловать, ${savedUserName}!`; }
        if (savedUserEmail) { setTextIfExists('userEmailPage', savedUserEmail); setTextIfExists('userEmailModal', savedUserEmail); }
        const color = savedColor || '#2a7fff'; ['Page', 'Modal'].forEach(prefix => { setTextIfExists(`colorValue${prefix}`, color); setBgIfExists(`colorPreview${prefix}`, color); });
        bindColorPicker('Modal');
      } catch {}
    });

    // Toasts
    const toastRoot = document.createElement('div'); toastRoot.className = 'toast-root'; document.body.appendChild(toastRoot);
    function showToast(text, type = 'info') { const el = document.createElement('div'); el.className = `toast ${type}`; el.textContent = text; toastRoot.appendChild(el); setTimeout(() => el.remove(), 3000); }

    // Loader overlay
    const overlay = document.getElementById('loadingOverlay');
    const showLoading = () => overlay.classList.add('active');
    const hideLoading = () => overlay.classList.remove('active');

    // Drag & drop import
    const uploadArea = document.getElementById('fileUploadArea');
    if (uploadArea) {
      ['dragenter','dragover'].forEach(ev => uploadArea.addEventListener(ev, e => { e.preventDefault(); uploadArea.style.borderColor = 'var(--accent-blue)'; }));
      ['dragleave','drop'].forEach(ev => uploadArea.addEventListener(ev, e => { e.preventDefault(); uploadArea.style.borderColor = 'var(--border)'; }));
      uploadArea.addEventListener('drop', async (e) => {
        const f = e.dataTransfer.files?.[0]; if (!f) return;
        try {
          showLoading();
          const ok = await ensureXlsx(); if (!ok) { hideLoading(); return; }
          const name = f.name; const ext = name.split('.').pop().toLowerCase();
          if (ext === 'csv') { const text = await f.text(); const wb = XLSX.read(text, { type: 'string' }); await openSheetPicker(wb, name); }
          else { const buf = await f.arrayBuffer(); const wb = XLSX.read(buf, { type: 'array' }); await openSheetPicker(wb, name); }
          showToast('Файл загружен', 'success');
        } catch (err) { showToast('Ошибка загрузки файла: ' + err.message, 'error'); } finally { hideLoading(); }
      });
    }

    // Explicit file input
    const selectFileBtn = document.getElementById('selectFileBtn'); const fileInput = document.getElementById('fileInput');
    if (selectFileBtn && fileInput) {
      selectFileBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); fileInput.click(); });
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0]; if (!file) return;
        const name = file.name; const ext = name.split('.').pop().toLowerCase();
        try {
          showLoading();
          const ok = await ensureXlsx(); if (!ok) { fileInput.value=''; hideLoading(); return; }
          if (ext === 'csv') { const text = await file.text(); const wb = XLSX.read(text, { type: 'string' }); await openSheetPicker(wb, name); }
          else { const buf = await file.arrayBuffer(); const wb = XLSX.read(buf, { type: 'array' }); await openSheetPicker(wb, name); }
          showToast('Файл загружен', 'success');
        } catch (err) { showToast('Ошибка чтения файла: ' + err.message, 'error'); } finally { fileInput.value = ''; hideLoading(); }
      });
    }

    // Open directory (Electron)
    const openDirBtn = document.getElementById('openDirBtn');
    if (openDirBtn) {
      openDirBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        try {
          showLoading();
          const ok = await ensureXlsx(); if (!ok) { hideLoading(); return; }
          await loadBuiltInTariffs();
          const files = await window.electronAPI.openDirectory();
          if (!files || files.length === 0) return;
          let created = 0; const logs = []; let lastCatalogId = null; let lastFunnelId = null;
          for (const f of files) {
            try {
              let rows = [];
              if (window.electronAPI.parseWorkbook) {
                const parsed = await window.electronAPI.parseWorkbook(f.data, f.ext);
                const bestName = parsed.sheetNames?.[0] || '';
                rows = (parsed.sheets.find(s=>s.name===bestName)?.rows) || [];
              }
              const cls = classifyDataset(rows, bestName);
              const createdItem = await window.electronAPI.datasets.create(`${f.name} [${bestName}]`, rows, { from: 'dir', type: cls.type });
              if (cls.type === 'catalog' && createdItem?.id) lastCatalogId = createdItem.id;
              if (cls.type === 'sales_funnel' && createdItem?.id) lastFunnelId = createdItem.id;
              created += 1; logs.push(`${f.name}✓`);
            } catch (err) { logs.push(`${f.name}✗`); }
          }
          showToast(`Импортировано наборов: ${created}`, 'success');
          const summary = document.getElementById('fileSummary'); if (summary) summary.textContent = `Импорт завершён. ${created} наборов. ${logs.slice(0,6).join(', ')}${logs.length>6?'…':''}`;
          renderDatasets();
          if (lastCatalogId) {
            const reportsBtn = document.querySelector('[data-tab="reports"]');
            if (reportsBtn) {
              reportsBtn.click();
              setTimeout(async ()=>{
                try {
                  await renderReports(); await loadExistingMapping();
                  const dsSel = document.getElementById('reportDatasetSelect'); if (dsSel) { dsSel.value = lastCatalogId; dsSel.dispatchEvent(new Event('change')); }
                  selectedReportId = 'unit-economics-v1'; await updateMappingPanel();
                  try { const fields = await getAvailableFieldsForSelectedDataset(); autoMapColumns(fields); } catch {}
                  await runSelectedReport();
                } catch {}
              }, 0);
            }
          }
          else if (lastFunnelId) {
            const reportsBtn = document.querySelector('[data-tab="reports"]');
            if (reportsBtn) {
              reportsBtn.click();
              setTimeout(async ()=>{
                try {
                  await renderReports(); await loadExistingMapping();
                  const dsSel = document.getElementById('reportDatasetSelect'); if (dsSel) { dsSel.value = lastFunnelId; dsSel.dispatchEvent(new Event('change')); }
                  selectedReportId = 'funnel-bottlenecks'; await updateMappingPanel();
                  try { const fields = await getAvailableFieldsForSelectedDataset(); autoMapColumns(fields); } catch {}
                  await runSelectedReport();
                } catch {}
              }, 0);
            }
          }
        } catch (err) { showToast('Ошибка: ' + err.message, 'error'); } finally { hideLoading(); }
      });
    }

    // Sheet picker helpers
    const sheetModal = document.getElementById('sheetModal');
    const closeSheetModal = document.getElementById('closeSheetModal');
    const cancelSheet = document.getElementById('cancelSheet');
    const applySheet = document.getElementById('applySheet');
    const sheetSelect = document.getElementById('sheetSelect');
    const sheetPreview = document.getElementById('sheetPreview');
    let tempWorkbook = null; let tempFileName = '';

    async function openSheetPicker(workbook, fileName) {
      tempWorkbook = workbook; tempFileName = fileName;
      const names = workbook.SheetNames || [];
      sheetSelect.innerHTML = names.map(n=>`<option value="${n}">${n}</option>`).join('');
      renderSheetPreview(names[0]);
      sheetModal.classList.add('active');
      document.body.classList.add('modal-open');
      return new Promise((resolve)=>{
        applySheet.onclick = async ()=>{ const sel = sheetSelect.value; const ws = workbook.Sheets[sel]; const rows = rowsFromSheetSmart(ws); currentData = rows; const cls = classifyDataset(rows, sel); const summary = document.getElementById('fileSummary'); if (summary) summary.textContent = `Файл «${tempFileName}», лист «${sel}»: ${rows.length||0} строк. Тип: ${cls.label}`; let created = null; try { if (window.electronAPI?.datasets?.create) { created = await window.electronAPI.datasets.create(`${tempFileName} [${sel}]`, rows, { from: 'single', type: cls.type }); } } catch {} sheetModal.classList.remove('active'); document.body.classList.remove('modal-open'); const reportsBtn = document.querySelector('[data-tab="reports"]'); if (reportsBtn) { reportsBtn.click(); setTimeout(async ()=>{ try{ await renderReports(); await loadExistingMapping(); if (cls.type==='catalog' && created?.id) { const dsSel = document.getElementById('reportDatasetSelect'); if (dsSel) { dsSel.value = created.id; dsSel.dispatchEvent(new Event('change')); } selectedReportId = 'unit-economics-v1'; await updateMappingPanel(); try { const fields = await getAvailableFieldsForSelectedDataset(); autoMapColumns(fields); } catch {} await runSelectedReport(); } }catch(e){ } }, 0); } resolve(true); };
        const cancel = ()=>{ sheetModal.classList.remove('active'); document.body.classList.remove('modal-open'); resolve(false); };
        cancelSheet.onclick = cancel; closeSheetModal.onclick = cancel;
        sheetModal.onclick = (e)=>{ if (e.target===sheetModal) cancel(); };
      });
    }

    function renderSheetPreview(name) {
      try { const ws = tempWorkbook?.Sheets?.[name]; if (!ws) { sheetPreview.innerHTML=''; return; } const rows = rowsFromSheetSmart(ws).slice(0, 50); sheetPreview.innerHTML = renderTable(rows); }
      catch { sheetPreview.innerHTML=''; }
    }
    if (sheetSelect) sheetSelect.addEventListener('change', ()=> renderSheetPreview(sheetSelect.value));

    // Integrate sheet picker into drag&drop
    if (uploadArea) {
      uploadArea.addEventListener('drop', async (e) => {
        const f = e.dataTransfer.files?.[0]; if (!f) return;
        try {
          showLoading();
          const ok = await ensureXlsx(); if (!ok) { hideLoading(); return; }
          const name = f.name; const ext = name.split('.').pop().toLowerCase();
          if (ext === 'csv') { const text = await f.text(); const wb = XLSX.read(text, { type: 'string' }); await openSheetPicker(wb, name); }
          else { const buf = await f.arrayBuffer(); const wb = XLSX.read(buf, { type: 'array' }); await openSheetPicker(wb, name); }
          showToast('Файл загружен', 'success');
        } catch (err) { showToast('Ошибка загрузки файла: ' + err.message, 'error'); } finally { hideLoading(); }
      });
    }

    // Integrate sheet picker into openExcelDialog as well
    async function openExcelDialog() {
      try {
        showLoading();
        const ok = await ensureXlsx(); if (!ok) { hideLoading(); return; }
        const file = await window.electronAPI.openFile();
        if (!file) return;
        if (window.electronAPI.parseWorkbook) {
          const parsed = await window.electronAPI.parseWorkbook(file.data, file.ext);
          // If multiple sheets, open picker; otherwise use the single sheet
          if (parsed.sheetNames && parsed.sheetNames.length>1) {
            // Rebuild workbook-like obj for picker
            const wb = { SheetNames: parsed.sheetNames, Sheets: {} };
            parsed.sheets.forEach(s=>{ wb.Sheets[s.name] = { __rows: s.rows }; });
            // Adapt rowsFromSheetSmart for picker usage
            const original = window.rowsFromSheetSmart;
            window.rowsFromSheetSmart = function(ws){ return ws.__rows || []; };
            await openSheetPicker(wb, file.name);
            window.rowsFromSheetSmart = original;
          } else {
            currentData = parsed.sheets?.[0]?.rows || [];
            showToast('Файл Excel загружен', 'success');
          }
        }
        document.querySelector('[data-tab="unit-economics"]').click();
      } catch (err) { showToast('Ошибка чтения файла: ' + err.message, 'error'); }
      finally { hideLoading(); }
    }

    // Datasets UI
    async function renderDatasets() {
      const table = document.getElementById('datasetsTable'); const tbody = table?.querySelector('tbody'); const prevEl = document.getElementById('datasetPreview'); const q = (document.getElementById('datasetsSearch')?.value || '').trim().toLowerCase();
      if (!tbody || !prevEl) return;
      let items = await window.electronAPI.datasets.list();
      if (q) items = items.filter(i => i.name.toLowerCase().includes(q));
             if (!items || items.length === 0) { tbody.innerHTML = '<tr><td colspan="4"><div class="empty"><i class="ti ti-database"></i>Нет сохранённых наборов данных</div></td></tr>'; prevEl.innerHTML=''; return; }
      tbody.innerHTML = items.map(i => `<tr data-id="${i.id}"><td>${i.name}</td><td>${new Date(i.createdAt).toLocaleString()}</td><td>${i.rowsCount}</td><td><div style=\"display:flex; gap:6px;\"><button class=\"icon-btn\" title=\"Предпросмотр\" data-action=\"preview\"><i class=\"ti ti-eye\"></i></button><button class=\"icon-btn\" title=\"Переименовать\" data-action=\"rename\"><i class=\"ti ti-pencil\"></i></button><button class=\"icon-btn danger\" title=\"Удалить\" data-action=\"delete\"><i class=\"ti ti-trash\"></i></button></div></td></tr>`).join('');
      tbody.querySelectorAll('[data-action]')?.forEach(btn => {
        btn.addEventListener('click', async () => {
          const row = btn.closest('tr'); const id = row.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if (action === 'preview') { const data = await window.electronAPI.datasets.get(id); const rows = data?.rows || []; prevEl.innerHTML = renderTable(rows.slice(0, 100)); }
          else if (action === 'rename') { const newName = prompt('Новое имя набора:'); if (!newName) return; await window.electronAPI.datasets.rename(id, newName); showToast('Набор переименован', 'success'); renderDatasets(); }
          else if (action === 'delete') { if (!confirm('Удалить набор данных?')) return; await window.electronAPI.datasets.delete(id); showToast('Набор удалён', 'success'); renderDatasets(); }
        });
      });
    }

    function renderTable(rows) {
      if (!rows || rows.length === 0) return '<div style="color:var(--text-secondary)">Пусто</div>';
      const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
      const thead = `<tr>${cols.map(c => `<th style=\"text-align:left; padding:8px; border-bottom:1px solid var(--border)\">${c}</th>`).join('')}</tr>`;
      const tbody = rows.map(r => `<tr>${cols.map(c => `<td style=\"padding:8px; border-bottom:1px solid var(--border)\">${r[c] ?? ''}</td>`).join('')}</tr>`).join('');
      return `<div style=\"overflow:auto; border:1px solid var(--border); border-radius:8px;\"><table style=\"border-collapse:collapse; min-width:600px; width:100%\">${thead}${tbody}</table></div>`;
    }

    const saveDatasetBtn = document.getElementById('saveDatasetBtn');
    if (saveDatasetBtn) {
      saveDatasetBtn.addEventListener('click', async () => {
        if (!currentData || !currentData.length) { showToast('Нет данных для сохранения', 'error'); return; }
        const name = prompt('Имя набора данных:', 'Новый набор'); if (!name) return;
        showLoading();
        try { await window.electronAPI.datasets.create(name, currentData, { from: 'import' }); showToast('Набор сохранён', 'success'); renderDatasets(); }
        catch (e) { showToast('Ошибка сохранения набора', 'error'); }
        finally { hideLoading(); }
      });
    }

    { const dtab = document.querySelector('[data-tab="datasets"]'); if (dtab) dtab.addEventListener('click', () => { setTimeout(renderDatasets, 0); }); }
    const datasetsSearch = document.getElementById('datasetsSearch'); if (datasetsSearch) datasetsSearch.addEventListener('input', () => renderDatasets());
    const toggleDensityBtn = document.getElementById('toggleDensity'); if (toggleDensityBtn) toggleDensityBtn.addEventListener('click', ()=>{ const content = document.getElementById('datasetsContent'); content?.classList.toggle('compact'); });

    // Reports
    const reportsRegistry = [
      { id: 'summary-basic', name: 'Сводка по данным', description: 'Количество строк и колонок, список полей', requiredFields: [], compute: (rows) => { const rowsCount = rows.length; const fields = Array.from(new Set(rows.flatMap(r => Object.keys(r)))); return { summary: { rowsCount, columnsCount: fields.length }, rows: fields.map(f => ({ field: f })) }; } },
      { id: 'unit-mock', name: 'Юнит-экономика (черновик)', description: 'Пример отчёта с маппингом: Цена, Себестоимость, Комиссия, Логистика', requiredFields: ['price', 'cost', 'commission', 'logistics'], compute: (rows, mapping) => { const mapped = (row, key) => row[mapping[key] || key]; const result = rows.map(r => { const price = Number(mapped(r, 'price')) || 0; const cost = Number(mapped(r, 'cost')) || 0; const commission = Number(mapped(r, 'commission')) || 0; const logistics = Number(mapped(r, 'logistics')) || 0; const margin = price - cost - commission - logistics; const marginPct = price ? (margin / price) * 100 : 0; return { price, cost, commission, logistics, margin, marginPct: Number(marginPct.toFixed(2)) }; }); return { summary: null, rows: result }; } },
      { id: 'catalog-audit', name: 'Аудит каталога', description: 'Проверка SKU, цен, себестоимости и категорий', requiredFields: [], compute: (rows) => {
        if (!rows || rows.length===0) return { summary: { rowsCount: 0, columnsCount: 0 }, rows: [] };
        const keys = Object.keys(rows[0]||{});
        const lc = keys.map(k=>k.toLowerCase());
        function findKey(cands){ const set = new Set(lc); for (const c of cands){ const idx = lc.findIndex(k=>k===c.toLowerCase()); if (idx!==-1) return keys[idx]; const fz = lc.findIndex(k=>k.includes(c.toLowerCase())); if (fz!==-1) return keys[fz]; } return null; }
        const skuK = findKey(['sku','ваш sku','артикул продавца']);
        const nameK = findKey(['name','название товара','наименование']);
        const catK = findKey(['category_path','категория на маркете','категория']);
        const priceK = findKey(['price','цена','стоимость продажи']);
        const costK = findKey(['cost','себестоимость','закуп','закупка']);
        const issues = [];
        const seen = new Map();
        rows.forEach(r=>{ const sku = (skuK? r[skuK]:null)||''; seen.set(sku, (seen.get(sku)||0)+1); });
        rows.forEach(r=>{
          const sku = (skuK? r[skuK]:null)||'';
          const name = (nameK? r[nameK]:null)||'';
          const cat = (catK? r[catK]:null)||'';
          const price = Number(String(priceK? r[priceK]:0).toString().replace(/[^0-9.,-]/g,'').replace(',','.'))||0;
          const cost = Number(String(costK? r[costK]:0).toString().replace(/[^0-9.,-]/g,'').replace(',','.'))||0;
          const duplicates = sku? (seen.get(sku)>1) : false;
          const missing = (!sku || !name || !cat);
          const badNumbers = (price<=0 || cost<0 || (cost>0 && price>0 && cost>price));
          const margin = price - cost;
          if (duplicates || missing || badNumbers){ issues.push({ sku, name, category_path: cat, price, cost, margin, duplicate: duplicates, missing_fields: missing, suspicious: badNumbers }); }
        });
        const summary = { rowsCount: rows.length, columnsCount: Object.keys(rows[0]||{}).length };
        return { summary, rows: issues.sort((a,b)=> Number(b.duplicate)-Number(a.duplicate) || Number(b.suspicious)-Number(a.suspicious) || (b.margin-a.margin)) };
      } },
      { id: 'unit-economics-v1', name: 'Юнит‑экономика v1', description: 'Комиссия по тарифам FBY/FBS/DBS; маржа по цене/себестоимости', requiredFields: ['sku','name','category_path','price','scheme','cost'], compute: (rows, mapping) => { const m=(r,k)=> r[mapping[k]||k]; const out = rows.map(r=>{ const sku=m(r,'sku'); const name=m(r,'name'); const cat=m(r,'category_path')||m(r,'Категория на Маркете *')||m(r,'Категория'); const scheme=(String(m(r,'scheme')||'FBS').toUpperCase()); const price=Number(String(m(r,'price')).replace(/[^0-9.,-]/g,'').replace(',','.'))||0; const cost=Number(String(m(r,'cost')).replace(/[^0-9.,-]/g,'').replace(',','.'))||0; const ratePct = matchTariffForCategory(['FBY','FBS','DBS'].includes(scheme)?scheme:'FBS', cat); const commission = price * (ratePct/100); const logistics = 0; const margin = price - cost - commission - logistics; const marginPct = price? (margin/price*100):0; return { sku, name, category_path:cat, scheme, price, cost, ratePct, commission: Number(commission.toFixed(2)), logistics, margin: Number(margin.toFixed(2)), marginPct: Number(marginPct.toFixed(2)) }; }); const kpi = []; const avgMargin = out.reduce((a,c)=>a+c.margin,0)/(out.length||1); const avgPct = out.reduce((a,c)=>a+c.marginPct,0)/(out.length||1); kpi.push({label:'Позиций', value: out.length}); kpi.push({label:'Средняя маржа ₽', value: avgMargin.toFixed(0)}); kpi.push({label:'Средняя маржинальность %', value: avgPct.toFixed(2)}); return { summary: { rowsCount: out.length, columnsCount: Object.keys(out[0]||{}).length, kpi }, rows: out }; } },
      { id: 'low-margin-alerts', name: 'Низкая маржинальность (сигналы)', description: 'SKU с отрицательной маржей или маржинальностью ниже порога', requiredFields: ['sku','name','category_path','price','scheme','cost'], compute: (rows, mapping) => { const m=(r,k)=> r[mapping[k]||k]; const out = rows.map(r=>{ const sku=m(r,'sku'); const name=m(r,'name'); const cat=m(r,'category_path')||m(r,'Категория на Маркете *')||m(r,'Категория'); const scheme=(String(m(r,'scheme')||'FBS').toUpperCase()); const price=Number(String(m(r,'price')).replace(/[^0-9.,-]/g,'').replace(',','.'))||0; const cost=Number(String(m(r,'cost')).replace(/[^0-9.,-]/g,'').replace(',','.'))||0; const ratePct = matchTariffForCategory(['FBY','FBS','DBS'].includes(scheme)?scheme:'FBS', cat); const commission = price * (ratePct/100); const logistics = 0; const margin = price - cost - commission - logistics; const marginPct = price? (margin/price*100):0; return { sku, name, category_path:cat, scheme, price, cost, ratePct, commission: Number(commission.toFixed(2)), logistics, margin: Number(margin.toFixed(2)), marginPct: Number(marginPct.toFixed(2)) }; }); const bad = out.filter(x=> x.margin<0 || x.marginPct<5); const kpi = [{label:'Проблемных SKU', value: bad.length}]; return { summary: { rowsCount: bad.length, columnsCount: Object.keys(bad[0]||{}).length, kpi }, rows: bad.sort((a,b)=> a.margin - b.margin) }; } },
      { id: 'sales-geography', name: 'География продаж (сводка)', description: 'Агрегация по региону', requiredFields: ['region','orders_units','orders_amount_rub'], compute: (rows, mapping) => { const g=(r,k)=> r[mapping[k]||k]; const data = rows.map(r=>({ region:g(r,'region')||g(r,'Регион'), units:Number(g(r,'orders_units'))||0, amount:Number(g(r,'orders_amount_rub'))||0 })); const grouped = {}; data.forEach(x=>{ if(!x.region) return; grouped[x.region] = grouped[x.region] || { region:x.region, units:0, amount:0 }; grouped[x.region].units+=x.units; grouped[x.region].amount+=x.amount; }); const table=Object.values(grouped).sort((a,b)=>b.amount-a.amount); return { summary: { rowsCount: table.length, columnsCount: 3 }, rows: table }; } },
      { id: 'boost-summary', name: 'Буст (сводка)', description: 'Сводные метрики по бусту, ROAS', requiredFields: ['campaign','spend_rub','orders_amount_rub'], compute: (rows, mapping) => { const g=(r,k)=> r[mapping[k]||k]; const data = rows.map(r=>({ campaign:g(r,'campaign')||g(r,'Кампания'), spend:Number(g(r,'spend_rub'))||0, revenue:Number(g(r,'orders_amount_rub'))||0 })); const grouped={}; data.forEach(x=>{ const key=x.campaign||'—'; grouped[key]=grouped[key]||{ campaign:key, spend:0, revenue:0 }; grouped[key].spend+=x.spend; grouped[key].revenue+=x.revenue; }); const table=Object.values(grouped).map(x=>({ ...x, roas: x.spend? Number((x.revenue/x.spend).toFixed(2)) : null })).sort((a,b)=>(b.revenue-a.revenue)); return { summary: { rowsCount: table.length, columnsCount: 4 }, rows: table }; } },
      { id: 'funnel-bottlenecks', name: 'Узкие места воронки', description: 'SKU/категории с просадкой конверсий', requiredFields: ['sku','brand','category','shows','added_to_cart','ordered_units','delivered_units'], compute: (rows, mapping) => { const g=(r,k)=> r[mapping[k]||k]; const norm = rows.map(r=>({ category:g(r,'category'), brand:g(r,'brand'), sku:g(r,'sku'), shows:Number(g(r,'shows'))||0, atc:Number(g(r,'added_to_cart'))||0, ord:Number(g(r,'ordered_units'))||0, del:Number(g(r,'delivered_units'))||0 })); const table = norm.map(x=>({ sku:x.sku, brand:x.brand, category:x.category, shows:x.shows, atc:x.atc, ord:x.ord, del:x.del, atc_rate: x.shows? Number((x.atc/x.shows*100).toFixed(2)) : 0, order_rate: x.atc? Number((x.ord/x.atc*100).toFixed(2)) : 0, delivery_rate: x.ord? Number((x.del/x.ord*100).toFixed(2)) : 0 })).filter(x=> x.shows>=100 && (x.order_rate<10 || x.delivery_rate<70)).sort((a,b)=> a.order_rate-b.order_rate || b.shows-a.shows); const kpi=[{label:'Проблемных позиций', value: table.length}]; return { summary: { rowsCount: table.length, columnsCount: Object.keys(table[0]||{}).length, kpi }, rows: table }; } },
      { id: 'sales-funnel', name: 'Воронка продаж (сводка)', description: 'Конверсия и эффективность по SKU/брендам/категориям', requiredFields: ['sku','brand','category','shows','added_to_cart','ordered_units','orders_amount_rub','delivered_units','delivered_amount_rub','visibility_index_pct','cart_to_order_conv_pct'], compute: (rows, mapping) => { const g=(r,k)=> r[mapping[k]||k]; const norm = rows.map(r=>({ category:g(r,'category'), brand:g(r,'brand'), sku:g(r,'sku'), shows:Number(g(r,'shows'))||0, atc:Number(g(r,'added_to_cart'))||0, ord:Number(g(r,'ordered_units'))||0, ordAmt:Number(g(r,'orders_amount_rub'))||0, del:Number(g(r,'delivered_units'))||0, delAmt:Number(g(r,'delivered_amount_rub'))||0, vis:Number(String(g(r,'visibility_index_pct')).replace(',','.'))||0, conv:Number(String(g(r,'cart_to_order_conv_pct')).replace(',','.'))||0 })); const total = norm.reduce((a,c)=>({ shows:a.shows+c.shows, atc:a.atc+c.atc, ord:a.ord+c.ord, ordAmt:a.ordAmt+c.ordAmt, del:a.del+c.del, delAmt:a.delAmt+c.delAmt }), {shows:0,atc:0,ord:0,ordAmt:0,del:0,delAmt:0}); const kpi=[{label:'Показы',value:total.shows},{label:'В корзину',value:total.atc},{label:'Заказано, шт',value:total.ord},{label:'Заказано, ₽',value:total.ordAmt.toFixed(0)},{label:'Доставлено, шт',value:total.del},{label:'Выручка, ₽',value:total.delAmt.toFixed(0)}]; const table = norm.map(x=>({ sku:x.sku, brand:x.brand, category:x.category, shows:x.shows, atc:x.atc, ord:x.ord, ordAmt: x.ordAmt, del:x.del, delAmt:x.delAmt, conv_pct: (x.ord && x.atc ? (x.ord/x.atc*100):0).toFixed(2) })).sort((a,b)=>b.delAmt-a.delAmt); return { summary: { rowsCount: rows.length, columnsCount: Object.keys(table[0]||{}).length, kpi }, rows: table }; } }
    ];

    let selectedReportId = reportsRegistry[0]?.id; let currentReportRows = [];

    async function renderReports() {
      const gallery = document.getElementById('reportsGallery');
      // Try build tariffs from existing datasets if not loaded
      try {
        if (!tariffsByScheme.FBY && window.electronAPI?.datasets?.list) {
          const items = await window.electronAPI.datasets.list();
          const guessIsTariff = (i)=> (i?.source?.type==='tariffs') || /\bFBY\b|\bFBS\b|\bDBS\b/i.test(i?.name||'');
          const tsets = items.filter(guessIsTariff).slice(0,6);
          for (const it of tsets) {
            const data = await window.electronAPI.datasets.get(it.id);
            const rows = data?.rows || [];
            const wbRows = rows; // already objects
            const list = wbRows.map(r=>({
              levels: [1,2,3,4,5,6,7].map(k=> r[`Категория (Уровень ${k})`] || null).filter(Boolean),
              ratePct: Number(String(r['Тариф с 1 июля 2025']||'').replace(',','.')) || 0
            }));
            if (/FBY/i.test(it.name)) tariffsByScheme.FBY = list;
            else if (/FBS/i.test(it.name)) tariffsByScheme.FBS = list;
            else if (/DBS/i.test(it.name)) tariffsByScheme.DBS = list;
          }
        }
      } catch {}
      gallery.innerHTML = reportsRegistry.map(r => `
        <div data-report-id="${r.id}" class="report-card">
          <div style="font-weight:600; margin-bottom:6px;">${r.name}</div>
          <div style="color:var(--text-secondary); font-size:13px;">${r.description}</div>
        </div>
      `).join('');
      gallery.querySelectorAll('[data-report-id]').forEach(card => { card.addEventListener('click', async () => { selectedReportId = card.getAttribute('data-report-id'); gallery.querySelectorAll('[data-report-id]').forEach(c => c.classList.remove('active')); card.classList.add('active'); await updateMappingPanel(); await loadExistingMapping(); const rr=document.getElementById('reportResult'); const rk=document.getElementById('reportKPI'); const re=document.getElementById('reportEmpty'); if (rr) rr.style.display='none'; if (rk) rk.style.display='none'; if (re) re.style.display='block'; }); });
 
      const select = document.getElementById('reportDatasetSelect'); const items = await window.electronAPI.datasets.list(); select.innerHTML = items.map(i => `<option value="${i.id}">${i.name} (${i.rowsCount})</option>`).join('');
      await updateMappingPanel();
      select.addEventListener('change', async () => { await updateMappingPanel(); await loadExistingMapping(); const rr=document.getElementById('reportResult'); const rk=document.getElementById('reportKPI'); const re=document.getElementById('reportEmpty'); if (rr) rr.style.display='none'; if (rk) rk.style.display='none'; if (re) re.style.display='block'; });
    }

    async function getAvailableFieldsForSelectedDataset() {
      const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value;
      const data = await window.electronAPI.datasets.get(datasetId);
      const rows = data?.rows || [];
      return Array.from(new Set(rows.flatMap(r => Object.keys(r))));
    }

    async function updateMappingPanel() {
      const report = reportsRegistry.find(r => r.id === selectedReportId); const panel = document.getElementById('mappingPanel'); const fieldsWrap = document.getElementById('mappingFields'); if (!report) return;
      if (report.requiredFields && report.requiredFields.length > 0) {
        panel.style.display = 'block';
        const availableFields = await getAvailableFieldsForSelectedDataset();
        fieldsWrap.innerHTML = report.requiredFields.map(f => {
          const opts = ['<option value="">— выберите колонку —</option>'].concat(availableFields.map(v => `<option value="${v}">${v}</option>`)).join('');
          return `<div style=\"color:var(--text-secondary)\">${f}</div><select data-map-key=\"${f}\" class=\"input\">${opts}</select>`;
        }).join('');
      } else { panel.style.display = 'none'; fieldsWrap.innerHTML = ''; }
    }

    async function loadExistingMapping() {
      const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value; const mapping = await window.electronAPI.mappings.get(datasetId, selectedReportId);
      document.querySelectorAll('[data-map-key]')?.forEach(input => { const key = input.getAttribute('data-map-key'); if (mapping && mapping[key]) input.value = mapping[key]; });
    }

    function autoMapColumns(availableFields) {
      const synonyms = {
        // unit
        price: ['price','цена','цена *','стоимость продажи','продажа'],
        cost: ['cost','себестоимость','закуп','закупка'],
        commission: ['commission','комиссия'],
        logistics: ['logistics','логистика','доставка','тариф доставки'],
        scheme: ['scheme','схема работы','fbs','fby','dbs'],
        // catalog
        sku: ['sku','ваш sku','ваш sku *','артикул продавца','ваш sku *_1'],
        name: ['name','название товара','название товара *','наименование'],
        category: ['category','категория','категория на маркете *','категория_1'],
        category_path: ['категория на маркете *','категория'],
        weight_kg: ['вес с упаковкой, кг','вес кг','weight','weight_kg'],
        dimensions_cm: ['габариты с упаковкой, см','габариты'],
        // funnel
        brand: ['бренд','brand'],
        shows: ['показы моих товаров, шт.','показы','shows'],
        added_to_cart: ['добавления в корзину, шт.','добавления в корзину','added_to_cart'],
        ordered_units: ['заказанные товары, шт.','ordered_units'],
        orders_amount_rub: ['заказано товаров на сумму, ₽','orders_amount_rub'],
        delivered_units: ['доставлено за период, шт.','delivered_units'],
        delivered_amount_rub: ['доставлено за период на сумму, ₽','delivered_amount_rub'],
        visibility_index_pct: ['индекс видимости, %'],
        cart_to_order_conv_pct: ['конверсия из корзины в заказ, %'],
        // geography
        region: ['регион','region'],
        // boost
        campaign: ['кампания','campaign'],
        spend_rub: ['расход','spend','spend_rub']
      };
      document.querySelectorAll('[data-map-key]')?.forEach(sel => {
        const key = sel.getAttribute('data-map-key');
        const candidates = (synonyms[key] || []).map(s => s.toLowerCase());
        const match = availableFields.find(f => candidates.includes(f.toLowerCase())) || availableFields.find(f => f.toLowerCase() === key);
        if (match) sel.value = match;
      });
    }

    async function runSelectedReport() {
      const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value; if (!datasetId) { showToast('Выберите набор данных', 'error'); return; }
      const report = reportsRegistry.find(r => r.id === selectedReportId); if (!report) { showToast('Не выбран отчёт', 'error'); return; }
      showLoading();
      try {
        try { await loadBuiltInTariffs(); } catch {}
        const data = await window.electronAPI.datasets.get(datasetId); const rows = data?.rows || [];
        let mapping = {}; if (report.requiredFields && report.requiredFields.length > 0) { document.querySelectorAll('[data-map-key]')?.forEach(sel => { const key = sel.getAttribute('data-map-key'); if (sel.value) mapping[key] = sel.value; }); }
        const result = report.compute(rows, mapping);
        currentReportRows = result.rows || [];
        const resultEl = document.getElementById('reportResult'); const kpiEl = document.getElementById('reportKPI'); const emptyEl = document.getElementById('reportEmpty');
        const summaryBlock = result.summary ? `<div style="margin-bottom:12px; color:var(--text-secondary)">Строк: ${result.summary.rowsCount}, Полей: ${result.summary.columnsCount}</div>` : '';
        resultEl.innerHTML = `${summaryBlock}${renderTable(currentReportRows.slice(0, 1000))}`;
        if (resultEl) resultEl.style.display='block'; if (emptyEl) emptyEl.style.display='none';
        // KPI header (simple)
        const kpis = [];
        if (report.id === 'unit-mock') {
          const n = currentReportRows.length || 1;
          const avgMargin = (currentReportRows.reduce((a,c)=>a+(Number(c.margin)||0),0)/n)||0;
          const avgPct = (currentReportRows.reduce((a,c)=>a+(Number(c.marginPct)||0),0)/n)||0;
          const series = currentReportRows.slice(0, 50).map(r=>Number(r.margin)||0);
          kpis.push({ label:'Записей', value:n });
          kpis.push({ label:'Средняя маржа', value: avgMargin.toFixed(0), series });
          kpis.push({ label:'Маржа, %', value: avgPct.toFixed(2)+'%', series: currentReportRows.slice(0,50).map(r=>Number(r.marginPct)||0) });
        } else if (result.summary) {
          kpis.push({ label:'Строк', value: result.summary.rowsCount });
          kpis.push({ label:'Полей', value: result.summary.columnsCount });
        }
        if (kpis.length) {
          kpiEl.style.display='grid';
          kpiEl.innerHTML = kpis.map((k,i)=>`<div class="kpi-card glass"><div class="kpi-label">${k.label}</div><div class="kpi-value">${k.value}</div>${k.series?`<canvas class="kpi-spark" id="kpiSpark${i}"></canvas>`:''}</div>`).join('');
          // render sparklines
          if (window.Chart) {
            kpis.forEach((k,i)=>{ if (!k.series) return; const cvs = document.getElementById(`kpiSpark${i}`); if (!cvs) return; const ctx = cvs.getContext('2d'); new Chart(ctx, { type:'line', data:{ labels:k.series.map((_,idx)=>idx+1), datasets:[{ data:k.series, borderColor:'rgba(42,127,255,1)', backgroundColor:'rgba(42,127,255,0.15)', fill:true, tension:0.35, pointRadius:0 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }, tooltip:{ enabled:false } }, scales:{ x:{ display:false }, y:{ display:false } } }); });
          }
        } else { kpiEl.style.display='none'; kpiEl.innerHTML=''; }
        renderChartIfApplicable(resultEl, currentReportRows);
        showToast('Отчёт готов', 'success');
      } catch (e) { showToast('Ошибка генерации отчёта', 'error'); } finally { hideLoading(); }
    }

    function renderChartIfApplicable(container, rows) {
      const hasMargin = rows.length && Object.prototype.hasOwnProperty.call(rows[0], 'margin');
      if (!hasMargin) return;
      if (!window.Chart) return;
      const canvas = document.createElement('canvas'); canvas.height = 220; container.prepend(canvas);
      const labels = rows.slice(0, 50).map((_, i) => `#${i+1}`);
      const values = rows.slice(0, 50).map(r => Number(r.margin) || 0);
      if (activeChart) { activeChart.destroy(); }
      const tickColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') || '#9aa0a6';
      activeChart = new Chart(canvas.getContext('2d'), { type: 'bar', data: { labels, datasets: [{ label: 'Маржа', data: values, backgroundColor: 'rgba(42,127,255,0.35)', borderColor: 'rgba(42,127,255,1)', borderWidth: 1, borderRadius: 6 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: tickColor }, grid: { color: 'rgba(255,255,255,0.05)' } }, y: { ticks: { color: tickColor }, grid: { color: 'rgba(255,255,255,0.05)' } } } } });
    }

    function exportToCsv(rows) {
      if (!rows || rows.length === 0) return; const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
      const csv = [cols.join(',')].concat(rows.map(r => cols.map(c => JSON.stringify(r[c] ?? '')).join(','))).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'report.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function exportToXlsx(rows) {
      if (!rows || rows.length === 0) return; if (!window.XLSX) { try{ showToast('Библиотека XLSX недоступна', 'error'); }catch{} return; } const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Report'); XLSX.writeFile(wb, 'report.xlsx');
    }

    document.getElementById('runReportBtn').addEventListener('click', runSelectedReport);
    document.getElementById('exportCsvBtn').addEventListener('click', () => exportToCsv(currentReportRows));
    document.getElementById('exportXlsxBtn').addEventListener('click', () => exportToXlsx(currentReportRows));

    const reportsTabBtn = document.querySelector('[data-tab="reports"]'); if (reportsTabBtn) { reportsTabBtn.addEventListener('click', async () => { try{ await renderReports(); await loadExistingMapping(); }catch(e){ showToast('Ошибка инициализации отчётов','error'); } }); }
    // Also render once on load so карточки всегда видны
    document.addEventListener('DOMContentLoaded', ()=>{ setTimeout(()=>{ try{ renderReports(); }catch(_){} }, 0); });

    document.getElementById('autoMapBtn').addEventListener('click', async () => { const fields = await getAvailableFieldsForSelectedDataset(); autoMapColumns(fields); });
    document.getElementById('saveMappingBtn').addEventListener('click', async () => { const select = document.getElementById('reportDatasetSelect'); const datasetId = select.value; const mapping = {}; document.querySelectorAll('[data-map-key]')?.forEach(sel => { const key = sel.getAttribute('data-map-key'); if (sel.value) mapping[key] = sel.value; }); await window.electronAPI.mappings.set(datasetId, selectedReportId, mapping); showToast('Маппинг сохранён', 'success'); });

    // Command palette implementation
    const cmdpal = document.getElementById('cmdpal');
    const cmdInput = document.getElementById('cmdInput');
    const cmdList = document.getElementById('cmdList');
    const commands = [
      { icon:'ti ti-home', label:'Перейти: Главная', run:()=>document.querySelector('[data-tab="dashboard"]').click() },
      { icon:'ti ti-database', label:'Перейти: Данные', run:()=>document.querySelector('[data-tab="datasets"]').click() },
      { icon:'ti ti-file-report', label:'Перейти: Отчёты', run:()=>document.querySelector('[data-tab="reports"]').click() },
      { icon:'ti ti-currency-rouble', label:'Перейти: Юнит-экономика', run:()=>document.querySelector('[data-tab="unit-economics"]').click() },
      { icon:'ti ti-settings', label:'Открыть настройки', run:()=>{ settingsModal.classList.add('active'); cmdpal.classList.remove('active'); } },
      { icon:'ti ti-upload', label:'Импорт: Выбрать файл (Юнит-экономика)', run:()=>{ document.querySelector('[data-tab="unit-economics"]').click(); setTimeout(()=>document.getElementById('selectFileBtn')?.click(), 100); } },
    ];
    function renderCmdList(filter=''){
      const f = filter.trim().toLowerCase();
      const rows = commands.filter(c=>!f || c.label.toLowerCase().includes(f));
      cmdList.innerHTML = rows.map((c,idx)=>`<div class="cmditem${idx===0?' active':''}" data-idx="${idx}"><i class="${c.icon}"></i><span>${c.label}</span></div>`).join('');
    }
    function openCmdPal(){ cmdpal.classList.add('active'); cmdInput.value=''; renderCmdList(); cmdInput.focus(); }
    function closeCmdPal(){ cmdpal.classList.remove('active'); }
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k') { e.preventDefault(); openCmdPal(); }
      if (e.key==='Escape') closeCmdPal();
    });
    cmdpal.addEventListener('click', (e)=>{ if (e.target===cmdpal) closeCmdPal(); });
    cmdInput.addEventListener('input', (e)=>{ renderCmdList(cmdInput.value); });
    cmdList.addEventListener('click', (e)=>{
      const item = e.target.closest('.cmditem'); if (!item) return;
      const idx = Number(item.getAttribute('data-idx'))||0;
      commands[idx].run(); closeCmdPal();
    });
    cmdInput.addEventListener('keydown', (e)=>{
      const items = Array.from(cmdList.querySelectorAll('.cmditem'));
      let active = items.findIndex(i=>i.classList.contains('active'));
      if (e.key==='ArrowDown') { e.preventDefault(); items[active]?.classList.remove('active'); active = (active+1)%items.length; items[active]?.classList.add('active'); }
      if (e.key==='ArrowUp') { e.preventDefault(); items[active]?.classList.remove('active'); active = (active-1+items.length)%items.length; items[active]?.classList.add('active'); }
      if (e.key==='Enter') { e.preventDefault(); const idx = Number(items[active]?.getAttribute('data-idx'))||0; commands[idx].run(); closeCmdPal(); }
    });

    // bindTabs disabled in favor of delegated handler above to avoid double-binding
    // bindTabs();

    async function persistAccent(color) {
      try { await window.electronAPI.setSetting('accentColor', color); } catch {}
    }

    function restoreAccent(color) {
      applyAccent(color);
      const preview = document.getElementById('colorPreviewModal'); if (preview) preview.style.backgroundColor = color;
      const val = document.getElementById('colorValueModal'); if (val) val.textContent = color;
      const picker = document.getElementById('colorPickerModal'); if (picker) picker.value = color;
    }

    // Reintroduce persistent accent customization
    const colorPickerModal = document.getElementById('colorPickerModal');
    if (colorPickerModal) {
      colorPickerModal.addEventListener('input', async (e)=>{ const color = e.target.value; applyAccent(color); persistAccent(color); const prev = document.getElementById('colorPreviewModal'); if (prev) prev.style.backgroundColor=color; const span = document.getElementById('colorValueModal'); if (span) span.textContent=color; });
    }

    // Excel open via dialog
    document.addEventListener('keydown', (e)=>{ if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='i') { e.preventDefault(); openExcelDialog(); } });

    // Smart parsing utilities
    function normalizeHeaderCell(text) {
      if (text == null) return '';
      const t = String(text).replace(/\*/g, '').replace(/\s+/g, ' ').trim();
      return t;
    }
    function detectHeaderRow(rows, maxScan = 30) {
      const keyHints = ['Ваш SKU', 'Название товара', 'Категория', 'Цена', 'Индекс видимости'];
      let bestIdx = -1; let bestScore = -1;
      for (let i = 0; i < Math.min(rows.length, maxScan); i++) {
        const row = rows[i] || [];
        const cells = row.map(normalizeHeaderCell).filter(Boolean);
        const nonEmpty = cells.length;
        const hit = cells.reduce((a, c) => a + (keyHints.some(k => c.toLowerCase().includes(k.toLowerCase())) ? 1 : 0), 0);
        const score = hit * 10 + nonEmpty; // prioritize hint hits
        if (score > bestScore && nonEmpty >= 3) { bestScore = score; bestIdx = i; }
      }
      return bestIdx >= 0 ? bestIdx : 0;
    }
    function rowsFromSheetSmart(ws) {
      // read as matrix
      const matrix = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
      if (!matrix || matrix.length === 0) return [];
      const headerIdx = detectHeaderRow(matrix);
      const headerRow = (matrix[headerIdx] || []).map(normalizeHeaderCell);
      const cols = headerRow.map((h, idx) => h || `col_${idx+1}`);
      const dataRows = matrix.slice(headerIdx + 1);
      return dataRows
        .filter(r => (r || []).some(v => v !== null && v !== undefined && String(v).trim() !== ''))
        .map(r => {
          const obj = {};
          cols.forEach((c, i) => { obj[c] = r[i] ?? null; });
          return obj;
        });
    }
    function classifyDataset(rows, sheetName = '') {
      const lowerKeys = new Set(Object.keys(rows?.[0] || {}).map(k => k.toLowerCase()));
      const has = (substr) => Array.from(lowerKeys).some(k => k.includes(substr));
      if (has('индекс видимости') && has('доставлено') && has('корзин')) return { type: 'sales_funnel', label: 'Воронка продаж' };
      if (has('категория (уровень 1)') && has('тариф')) return { type: 'tariffs', label: 'Тарифы категорий' };
      if (/географ/i.test(sheetName) || has('регион')) return { type: 'geography', label: 'География продаж' };
      if (has('ваш sku') || has('категория на маркете') || has('габариты')) return { type: 'catalog', label: 'Каталог товаров' };
      if (has('кампания') || has('campaign') || has('расход') || has('spend') || has('заказано товаров на сумму') || has('orders_amount_rub')) return { type: 'boost', label: 'Буст рекламных кампаний' };
      return { type: 'generic', label: 'Данные' };
    }

    // Tariffs loader and category matching
    const tariffsByScheme = { FBY: null, FBS: null, DBS: null };
    async function tryFetchXlsx(pathRel) {
      try { const res = await fetch(pathRel); if (!res.ok) return null; const buf = await res.arrayBuffer(); return XLSX.read(buf, { type: 'array' }); } catch { return null; }
    }
    function parseTariffTable(wb) {
      if (!wb) return null;
      const name = wb.SheetNames?.[0]; const ws = wb.Sheets?.[name]; if (!ws) return null;
      const rows = rowsFromSheetSmart(ws);
      // Expect columns Category (Уровни 1..7) + Тариф с 1 июля 2025
      return rows.map(r => ({
        levels: [1,2,3,4,5,6,7].map(i => r[`Категория (Уровень ${i})`] || null).filter(Boolean),
        ratePct: Number(String(r['Тариф с 1 июля 2025']).replace(',','.')) || 0,
      }));
    }
    function matchTariffForCategory(scheme, categoryPath) {
      const list = tariffsByScheme[scheme]; if (!list || !categoryPath) return 0;
      const parts = String(categoryPath).split('/').map(s=>s.trim()).filter(Boolean);
      let best = 0; let bestDepth = -1;
      for (const t of list) {
        const depth = t.levels.length;
        if (depth===0) continue;
        const ok = t.levels.every((lvl, idx) => (parts[idx]||'').toLowerCase() === String(lvl).toLowerCase());
        if (ok && depth > bestDepth) { bestDepth = depth; best = t.ratePct; }
      }
      return best; // percent
    }
    async function loadBuiltInTariffs() {
      if (tariffsByScheme.FBY || tariffsByScheme.FBS || tariffsByScheme.DBS) return;
      let [wbfby, wbfbs, wbdbs] = await Promise.all([
        tryFetchXlsx('FBY.xlsx'), tryFetchXlsx('FBS.xlsx'), tryFetchXlsx('DBS.xlsx')
      ]);
      // Fallback to data/tariffs if root files are not available
      if (!wbfby || !wbfbs || !wbdbs) {
        const [fb, fs, db] = await Promise.all([
          wbfby ? Promise.resolve(null) : tryFetchXlsx('data/tariffs/FBY.xlsx'),
          wbfbs ? Promise.resolve(null) : tryFetchXlsx('data/tariffs/FBS.xlsx'),
          wbdbs ? Promise.resolve(null) : tryFetchXlsx('data/tariffs/DBS.xlsx')
        ]);
        if (!wbfby && fb) wbfby = fb;
        if (!wbfbs && fs) wbfbs = fs;
        if (!wbdbs && db) wbdbs = db;
      }
      tariffsByScheme.FBY = parseTariffTable(wbfby);
      tariffsByScheme.FBS = parseTariffTable(wbfbs);
      tariffsByScheme.DBS = parseTariffTable(wbdbs);
    }

    // Best sheet selection
    function scoreSheet(ws) {
      const matrix = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
      if (!matrix || !matrix.length) return -Infinity;
      const idx = detectHeaderRow(matrix);
      const header = (matrix[idx]||[]).map(normalizeHeaderCell);
      const hints = ['SKU','Категория','Название','Цена','Индекс видимости','Доставлено'];
      const hit = header.reduce((a,c)=> a + (hints.some(h=>c.toLowerCase().includes(h.toLowerCase()))?1:0), 0);
      const nonEmpty = header.filter(Boolean).length;
      return hit*10 + nonEmpty;
    }
    function selectBestSheet(wb) {
      let best = wb.SheetNames?.[0]; let bestScore=-Infinity;
      (wb.SheetNames||[]).forEach(n=>{ const s=scoreSheet(wb.Sheets[n]); if (s>bestScore) { bestScore=s; best=n; } });
      return best;
    }

    // Manual Unit Economics table logic
    function makeManualRow(row={}){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="input" value="${row.sku||''}" placeholder="SKU"/></td>
        <td><input class="input" value="${row.name||''}" placeholder="Название"/></td>
        <td><input class="input" value="${row.category_path||''}" placeholder="Категория / Путь"/></td>
        <td>
          <select class="input">
            <option ${row.scheme==='FBS'?'selected':''}>FBS</option>
            <option ${row.scheme==='FBY'?'selected':''}>FBY</option>
            <option ${row.scheme==='DBS'?'selected':''}>DBS</option>
          </select>
        </td>
        <td><input class="input" type="number" step="0.01" value="${row.price||''}" placeholder="0"/></td>
        <td><input class="input" type="number" step="0.01" value="${row.cost||''}" placeholder="0"/></td>
        <td><button class="icon-btn danger" title="Удалить"><i class="ti ti-trash"></i></button></td>
      `;
      const del = tr.querySelector('button');
      del.addEventListener('click', ()=> tr.remove());
      return tr;
    }
    function readManualRows(){
      const rows=[]; const tbody=document.querySelector('#unitManualTable tbody');
      tbody.querySelectorAll('tr').forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        rows.push({
          sku: tds[0].querySelector('input')?.value?.trim()||'',
          name: tds[1].querySelector('input')?.value?.trim()||'',
          category_path: tds[2].querySelector('input')?.value?.trim()||'',
          scheme: tds[3].querySelector('select')?.value?.trim()||'FBS',
          price: Number(tds[4].querySelector('input')?.value||0),
          cost: Number(tds[5].querySelector('input')?.value||0),
        });
      });
      return rows;
    }
    function writeManualRows(rows){
      const tbody=document.querySelector('#unitManualTable tbody');
      tbody.innerHTML='';
      rows.forEach(r=> tbody.appendChild(makeManualRow(r)));
      if (rows.length===0) tbody.appendChild(makeManualRow({}));
    }
    const addManualRowBtn = document.getElementById('addManualRowBtn'); if (addManualRowBtn) addManualRowBtn.addEventListener('click', ()=>{ const tbody=document.querySelector('#unitManualTable tbody'); tbody.appendChild(makeManualRow({})); });
    const loadToManualBtn = document.getElementById('loadToManualBtn'); if (loadToManualBtn) loadToManualBtn.addEventListener('click', ()=>{
      // map currentData (parsed) to manual schema when possible
      if (!currentData || !Array.isArray(currentData) || currentData.length===0) { showToast('Нет данных для загрузки в таблицу', 'error'); return; }
      const sample = currentData[0]||{}; const keys = Object.keys(sample).map(k=>k.toLowerCase());
      function pick(obj, names){ for (const n of names){ const k = Object.keys(obj).find(kk => kk.toLowerCase()===n.toLowerCase()); if (k) return obj[k]; } return ''; }
      const rows = currentData.slice(0, 500).map(r=>({
        sku: pick(r,['sku','ваш sku','ваш sku *','артикул продавца','ваш sku *_1']),
        name: pick(r,['name','название товара','название товара *','наименование']),
        category_path: pick(r,['category_path','категория на маркете *','категория']),
        scheme: 'FBS',
        price: Number(String(pick(r,['price','цена','цена *','стоимость продажи'])).replace(/[^0-9.,-]/g,'').replace(',','.'))||0,
        cost: Number(String(pick(r,['cost','себестоимость','закуп','закупка'])).replace(/[^0-9.,-]/g,'').replace(',','.'))||0,
      }));
      writeManualRows(rows);
      showToast('Данные загружены в таблицу', 'success');
    });
    async function computeManual(){
      await loadBuiltInTariffs().catch(()=>{});
      const rows = readManualRows();
      const result = rows.map(r=>{
        const ratePct = matchTariffForCategory((r.scheme||'FBS').toUpperCase(), r.category_path);
        const commission = r.price * (ratePct/100);
        const logistics = 0;
        const margin = r.price - r.cost - commission - logistics;
        const marginPct = r.price ? margin/r.price*100 : 0;
        return { ...r, ratePct, commission: Number(commission.toFixed(2)), logistics, margin: Number(margin.toFixed(2)), marginPct: Number(marginPct.toFixed(2)) };
      });
      const kpiHtml = (()=>{ const n=result.length||1; const avgMargin=(result.reduce((a,c)=>a+c.margin,0)/n)||0; const avgPct=(result.reduce((a,c)=>a+c.marginPct,0)/n)||0; return `<div class="kpi-grid" style="margin-bottom:8px;"><div class="kpi-card glass"><div class="kpi-label">Позиций</div><div class="kpi-value">${result.length}</div></div><div class="kpi-card glass"><div class="kpi-label">Средняя маржа</div><div class="kpi-value">${avgMargin.toFixed(0)}</div></div><div class="kpi-card glass"><div class="kpi-label">Средняя маржинальность</div><div class="kpi-value">${avgPct.toFixed(2)}%</div></div></div>`; })();
      const resultEl = document.getElementById('unitResult');
      if (resultEl) {
        resultEl.style.display='block';
        const displayRows = result.map(({sku,name,category_path,scheme,price,cost,ratePct,commission,logistics,margin,marginPct})=>({sku,name,category_path,scheme,price,cost,ratePct,commission,logistics,margin,marginPct}));
        resultEl.innerHTML = kpiHtml + renderTable(displayRows);
      }
      return result;
    }
    const computeUnitBtn = document.getElementById('computeUnitBtn'); if (computeUnitBtn) computeUnitBtn.addEventListener('click', computeManual);
    const saveManualDatasetBtn = document.getElementById('saveManualDatasetBtn'); if (saveManualDatasetBtn) saveManualDatasetBtn.addEventListener('click', async ()=>{
      const rows = readManualRows(); if (!rows.length) { showToast('Нет данных для сохранения', 'error'); return; }
      const name = prompt('Имя набора данных:', 'Юнитка (ручной ввод)'); if (!name) return;
      showLoading(); try { await window.electronAPI.datasets.create(name, rows, { from: 'manual', type: 'catalog' }); showToast('Набор сохранён', 'success'); } catch { showToast('Ошибка сохранения', 'error'); } finally { hideLoading(); }
    });
  </script>

  <script>
    // Safety helpers in case main init fails
    (function(){
      if (!window.showToast) window.showToast = function(t){ try{ console.log('[toast]', t); }catch{} };
      if (!window.hideLoading) window.hideLoading = function(){ const o=document.getElementById('loadingOverlay'); o&&o.classList.remove('active'); };
      if (!window.showLoading) window.showLoading = function(){ const o=document.getElementById('loadingOverlay'); o&&o.classList.add('active'); };
      document.addEventListener('click', function(e){
        var el;
        // Open reports: ensure gallery render
        el = e.target && e.target.closest ? e.target.closest('.nav-item[data-tab="reports"]') : null;
        if (el && typeof renderReports === 'function') { setTimeout(function(){ renderReports().catch?.(()=>{}); }, 0); }
        // Datasets tab: refresh list
        el = e.target && e.target.closest ? e.target.closest('.nav-item[data-tab="datasets"]') : null;
        if (el && typeof renderDatasets === 'function') { setTimeout(function(){ renderDatasets(); }, 0); }
        // Select file
        el = e.target && e.target.closest ? e.target.closest('#selectFileBtn') : null;
        if (el) { var inp=document.getElementById('fileInput'); if (inp) { e.preventDefault(); inp.click(); } }
        // Open directory
        el = e.target && e.target.closest ? e.target.closest('#openDirBtn') : null;
        if (el && window.electronAPI && typeof window.electronAPI.openDirectory === 'function') {
          e.preventDefault(); showLoading(); window.electronAPI.openDirectory().then(function(){ hideLoading(); }).catch(function(){ hideLoading(); });
        }
      }, true);
    })();
  </script>
</body>
</html>